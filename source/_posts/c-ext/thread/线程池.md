---
title: 线程池
toc: true
date: 2020-03-31 21:28:59
tags: [linux,c,php,ext,thread,pool]
---

## demo
```php
<?php

$pool = new Lib\Thread\Pool(4);

$ref = [1,2,3,4];

//future = Lib\Thread\Pool\Future
//future->wait() 可以阻塞返回结果
$future = $pool->add(function()use(&$ref){
    sleep(1);
    var_dump($ref);
});
$future->wait();
;
```

## @construct 创建线程数量
构造函数需要传入线程创建的参数，在初始化就默认创建固定的线程数量
## @add 投递执行任务
`add()` 函数接受一个php闭包函数，可通过引用的方式附加传入参数

投递后如果线程空闲，立即执行该任务
## @`Lib\Thread\Pool\Future`
投递任务后立即返回一个future包装器，可用于阻塞等待任务结束，转换为同步阻塞程序

// TODO : 该包装器可以阻塞等待并获取任务返回的结果,现在只能通过传递引用方式获取值
```php
$future = $pool->add(function(){});
```

### @`furture->wait()` 等待该异步任务处理结束
该函数用于等待，当前线程执行的任务结束
```
$future->wait();
```
### @异步任务demo 
将100个任务全部投递到线程排队处理，然后当前继续执行其他任务
```
for($i = 0;$i < 100 ;$i ++){
    $pool->add(function(){
        sleep(1);
    });
}
//这里继续执行其他任务
```
### @同步任务demo
将100个任务投递到线程处理，并逐一等待每一任务执行完毕
```
for($i = 0;$i < 100 ;$i ++){
    $future = $pool->add(function(){
        sleep(1);
    });
    $future->wait();
}
//这里继续阻塞，直到上面100s过期后任务处理完毕
```


