<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Brewlin&#39;s Wiki</title>
  
  <subtitle>found everthing</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.huido.site/"/>
  <updated>2019-10-21T07:50:21.779Z</updated>
  <id>http://blog.huido.site/</id>
  
  <author>
    <name>brewlin</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>websocket算法</title>
    <link href="http://blog.huido.site/wiki/net-protocol/2.%E5%BA%94%E7%94%A8%E5%B1%82/4.websocket%E7%AE%97%E6%B3%95/"/>
    <id>http://blog.huido.site/wiki/net-protocol/2.应用层/4.websocket算法/</id>
    <published>2019-10-21T13:28:59.000Z</published>
    <updated>2019-10-21T07:50:21.779Z</updated>
    
    <content type="html"><![CDATA[<h2 id="websocket协议中的一些算法"><a href="#websocket协议中的一些算法" class="headerlink" title="websocket协议中的一些算法"></a>websocket协议中的一些算法</h2><p>在分析 WebSocket 协议握手过程和数据帧格式过程中，我们讲到了一些算法，下面我们讲解下具体实现。</p><h2 id="Sec-WebSocket-Accept的计算方法"><a href="#Sec-WebSocket-Accept的计算方法" class="headerlink" title="Sec-WebSocket-Accept的计算方法"></a>Sec-WebSocket-Accept的计算方法</h2><h3 id="从上面的分析中，我们知道字段的值是通过固定字符串258EAFA5-E914-47DA-95CA-C5AB0DC85B11加上请求中Sec-WebSocket-Key字段的值，然后再对其结果通过-SHA1-哈希算法求出的结果。可以通过以下-golang-代码实现："><a href="#从上面的分析中，我们知道字段的值是通过固定字符串258EAFA5-E914-47DA-95CA-C5AB0DC85B11加上请求中Sec-WebSocket-Key字段的值，然后再对其结果通过-SHA1-哈希算法求出的结果。可以通过以下-golang-代码实现：" class="headerlink" title="从上面的分析中，我们知道字段的值是通过固定字符串258EAFA5-E914-47DA-95CA-C5AB0DC85B11加上请求中Sec-WebSocket-Key字段的值，然后再对其结果通过 SHA1 哈希算法求出的结果。可以通过以下 golang 代码实现："></a>从上面的分析中，我们知道字段的值是通过固定字符串<code>258EAFA5-E914-47DA-95CA-C5AB0DC85B1</code>1加上请求中<code>Sec-WebSocket-Key字</code>段的值，然后再对其结果通过 SHA1 哈希算法求出的结果。可以通过以下 golang 代码实现：</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> keyGUID = []<span class="keyword">byte</span>(<span class="string">"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">computeAcceptKey</span><span class="params">(challengeKey <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    h := sha1.New()</span><br><span class="line">    h.Write([]<span class="keyword">byte</span>(challengeKey))</span><br><span class="line">    h.Write(keyGUID)</span><br><span class="line">    <span class="keyword">return</span> base64.StdEncoding.EncodeToString(h.Sum(<span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="掩码处理"><a href="#掩码处理" class="headerlink" title="掩码处理"></a>掩码处理</h2><h3 id="浏览器发送给服务器的数据帧是经过掩码处理的，那怎么样对数据进行解码呢？以下是来自RFC6455文档的解释"><a href="#浏览器发送给服务器的数据帧是经过掩码处理的，那怎么样对数据进行解码呢？以下是来自RFC6455文档的解释" class="headerlink" title="浏览器发送给服务器的数据帧是经过掩码处理的，那怎么样对数据进行解码呢？以下是来自RFC6455文档的解释"></a>浏览器发送给服务器的数据帧是经过掩码处理的，那怎么样对数据进行解码呢？以下是来自<code>RFC6455</code>文档的解释</h3><h3 id="具体的流程是：将传输的数据按字节-byte-处理，同时将-Masking-key-代表的值也按字节处理。假如-data-byte-i-代表的是数据的第-i-个字节，那么-j-i-MOD-4，然后从Maksing-key中-一共有-4-个字节）取出第-j-个字节-mask-key-byte-j，然后将-data-byte-i-和-mask-key-byte-j-代表的字节进行异或操作，取得结果就是最终的结果。该操作可以用如下-golang-代码实现："><a href="#具体的流程是：将传输的数据按字节-byte-处理，同时将-Masking-key-代表的值也按字节处理。假如-data-byte-i-代表的是数据的第-i-个字节，那么-j-i-MOD-4，然后从Maksing-key中-一共有-4-个字节）取出第-j-个字节-mask-key-byte-j，然后将-data-byte-i-和-mask-key-byte-j-代表的字节进行异或操作，取得结果就是最终的结果。该操作可以用如下-golang-代码实现：" class="headerlink" title="具体的流程是：将传输的数据按字节 byte 处理，同时将 Masking-key 代表的值也按字节处理。假如 data-byte-i 代表的是数据的第 i 个字节，那么 j = i MOD 4，然后从Maksing-key中(一共有 4 个字节）取出第 j 个字节 mask-key-byte-j，然后将 data-byte-i 和 mask-key-byte-j 代表的字节进行异或操作，取得结果就是最终的结果。该操作可以用如下 golang 代码实现："></a>具体的流程是：将传输的数据按字节 byte 处理，同时将 <code>Masking-key</code> 代表的值也按字节处理。假如 <code>data-byte-i</code> 代表的是数据的第 <code>i</code> 个字节，那么 <code>j = i MOD 4</code>，然后从<code>Maksing-key</code>中(一共有 4 个字节）取出第 j 个字节 <code>mask-key-byte-j</code>，然后将 d<code>ata-byte-i</code> 和 <code>mask-key-byte-j</code> 代表的字节进行异或操作，取得结果就是最终的结果。该操作可以用如下 golang 代码实现：</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">maskBytes</span><span class="params">(key [4]<span class="keyword">byte</span>,pos <span class="keyword">int</span>,b[]<span class="keyword">byte</span>)</span><span class="title">int</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> b&#123;</span><br><span class="line">        b[i] ^= key[pos &amp; <span class="number">3</span>]</span><br><span class="line">        pos++</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pos &amp; <span class="number">3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="注意以上的操作，pos-amp-3这里代表的操作是pos-4-因为-a-2-n-等价于-a-amp-2-n-1-在这里使用按位与操作更加高效"><a href="#注意以上的操作，pos-amp-3这里代表的操作是pos-4-因为-a-2-n-等价于-a-amp-2-n-1-在这里使用按位与操作更加高效" class="headerlink" title="注意以上的操作，pos &amp; 3这里代表的操作是pos%4,因为 a % (2 ^ n) 等价于 a &amp; (2^n -1),在这里使用按位与操作更加高效"></a>注意以上的操作，<code>pos &amp; 3</code>这里代表的操作是pos%4,因为 a % (2 ^ n) 等价于 a &amp; (2^n -1),在这里使用按位与操作更加高效</h3>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;websocket协议中的一些算法&quot;&gt;&lt;a href=&quot;#websocket协议中的一些算法&quot; class=&quot;headerlink&quot; title=&quot;websocket协议中的一些算法&quot;&gt;&lt;/a&gt;websocket协议中的一些算法&lt;/h2&gt;&lt;p&gt;在分析 WebSoc
      
    
    </summary>
    
      <category term="net-protocol" scheme="http://blog.huido.site/categories/net-protocol/"/>
    
      <category term="2.应用层" scheme="http://blog.huido.site/categories/net-protocol/2-%E5%BA%94%E7%94%A8%E5%B1%82/"/>
    
    
      <category term="protocol" scheme="http://blog.huido.site/tags/protocol/"/>
    
      <category term="golang" scheme="http://blog.huido.site/tags/golang/"/>
    
      <category term="websocket" scheme="http://blog.huido.site/tags/websocket/"/>
    
  </entry>
  
  <entry>
    <title>websocket实现</title>
    <link href="http://blog.huido.site/wiki/net-protocol/2.%E5%BA%94%E7%94%A8%E5%B1%82/5.websocket%E5%AE%9E%E7%8E%B0/"/>
    <id>http://blog.huido.site/wiki/net-protocol/2.应用层/5.websocket实现/</id>
    <published>2019-10-21T13:28:59.000Z</published>
    <updated>2019-10-21T07:50:21.779Z</updated>
    
    <content type="html"><![CDATA[<h2 id="编写基本的httpserver"><a href="#编写基本的httpserver" class="headerlink" title="编写基本的httpserver"></a>编写基本的httpserver</h2><h3 id="启动一个基本的httpserver，提供两个接口，一个index返回主页，另一个是就是我们自定义的websocket协议接口"><a href="#启动一个基本的httpserver，提供两个接口，一个index返回主页，另一个是就是我们自定义的websocket协议接口" class="headerlink" title="启动一个基本的httpserver，提供两个接口，一个index返回主页，另一个是就是我们自定义的websocket协议接口"></a>启动一个基本的httpserver，提供两个接口，一个<code>index</code>返回主页，另一个是就是我们自定义的<code>websocket</code>协议接口</h3><h3 id="main-go"><a href="#main-go" class="headerlink" title="@main.go"></a>@main.go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"html/template"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"http/websocket"</span></span><br><span class="line">)</span><br><span class="line"><span class="comment">//websocket处理器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">echo</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span>&#123;</span><br><span class="line">    <span class="comment">//协议升级</span></span><br><span class="line">    c,err := websocket.Upgrade(w,r)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Print(<span class="string">"Upgrade error:"</span>,err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> c.Close()</span><br><span class="line">    <span class="comment">//循环处理数据，接受数据，然后返回</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        message,err := c.ReadData()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Println(<span class="string">"read:"</span>,err)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        log.Printf(<span class="string">"recv:%s"</span>,message)</span><br><span class="line">        c.SendData(message)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//index</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">home</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span>&#123;</span><br><span class="line">    homeTemplate.Execute(w,<span class="string">"ws://"</span>+r.Host+<span class="string">"/echo"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    log.SetFlags(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    http.HandleFunc(<span class="string">"/echo"</span>,echo)</span><br><span class="line">    http.HandleFunc(<span class="string">"/"</span>,home)</span><br><span class="line">    log.Fatal(http.ListenAndServe(<span class="string">"0.0.0.0:8000"</span>,<span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> homeTemplate = template.Must(template.New(<span class="string">""</span>).Parse(<span class="string">`</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;meta charset="utf-8"&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">window.addEventListener("load", function(evt) &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    var output = document.getElementById("output");</span></span><br><span class="line"><span class="string">    var input = document.getElementById("input");</span></span><br><span class="line"><span class="string">    var ws;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    var print = function(message) &#123;</span></span><br><span class="line"><span class="string">        var d = document.createElement("div");</span></span><br><span class="line"><span class="string">        d.innerHTML = message;</span></span><br><span class="line"><span class="string">        output.appendChild(d);</span></span><br><span class="line"><span class="string">    &#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    document.getElementById("open").onclick = function(evt) &#123;</span></span><br><span class="line"><span class="string">        if (ws) &#123;</span></span><br><span class="line"><span class="string">            return false;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        ws = new WebSocket("&#123;&#123;.&#125;&#125;");</span></span><br><span class="line"><span class="string">        ws.onopen = function(evt) &#123;</span></span><br><span class="line"><span class="string">            print("OPEN");</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        ws.onclose = function(evt) &#123;</span></span><br><span class="line"><span class="string">            print("CLOSE");</span></span><br><span class="line"><span class="string">            ws = null;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        ws.onmessage = function(evt) &#123;</span></span><br><span class="line"><span class="string">            print("RESPONSE: " + evt.data);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        ws.onerror = function(evt) &#123;</span></span><br><span class="line"><span class="string">            print("ERROR: " + evt.data);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        return false;</span></span><br><span class="line"><span class="string">    &#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    document.getElementById("send").onclick = function(evt) &#123;</span></span><br><span class="line"><span class="string">        if (!ws) &#123;</span></span><br><span class="line"><span class="string">            return false;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        print("SEND: " + input.value);</span></span><br><span class="line"><span class="string">        ws.send(input.value);</span></span><br><span class="line"><span class="string">        return false;</span></span><br><span class="line"><span class="string">    &#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    document.getElementById("close").onclick = function(evt) &#123;</span></span><br><span class="line"><span class="string">        if (!ws) &#123;</span></span><br><span class="line"><span class="string">            return false;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        ws.close();</span></span><br><span class="line"><span class="string">        return false;</span></span><br><span class="line"><span class="string">    &#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;table&gt;</span></span><br><span class="line"><span class="string">&lt;tr&gt;&lt;td valign="top" width="50%"&gt;</span></span><br><span class="line"><span class="string">&lt;p&gt;</span></span><br><span class="line"><span class="string">点击 "Open" 开始一个新的WebSocket链接,</span></span><br><span class="line"><span class="string">“Send" 将内容发送到服务器，</span></span><br><span class="line"><span class="string">"Close" 将关闭链接。</span></span><br><span class="line"><span class="string">&lt;p&gt;</span></span><br><span class="line"><span class="string">&lt;form&gt;</span></span><br><span class="line"><span class="string">&lt;button id="open"&gt;Open&lt;/button&gt;</span></span><br><span class="line"><span class="string">&lt;button id="close"&gt;Close&lt;/button&gt;</span></span><br><span class="line"><span class="string">&lt;p&gt;&lt;input id="input" type="text" value="hello world!"&gt;</span></span><br><span class="line"><span class="string">&lt;button id="send"&gt;Send&lt;/button&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;/td&gt;&lt;td valign="top" width="50%"&gt;</span></span><br><span class="line"><span class="string">&lt;div id="output"&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">`</span>))</span><br></pre></td></tr></table></figure><h3 id="index-返回我们自定义的一段html代码，"><a href="#index-返回我们自定义的一段html代码，" class="headerlink" title="index 返回我们自定义的一段html代码，"></a>index 返回我们自定义的一段html代码，</h3><h3 id="echo-接口进行升级我们的websocket"><a href="#echo-接口进行升级我们的websocket" class="headerlink" title="echo 接口进行升级我们的websocket"></a>echo 接口进行升级我们的websocket</h3><h3 id="页面如下"><a href="#页面如下" class="headerlink" title="页面如下"></a>页面如下</h3><p><img src="/resource/images/Linux/20190502222316.png" alt="index"></p><h2 id="自定义的webscoket-upgrade进行升级"><a href="#自定义的webscoket-upgrade进行升级" class="headerlink" title="自定义的webscoket upgrade进行升级"></a>自定义的webscoket upgrade进行升级</h2><h3 id="根据之前的协议分析，我知道握手的过程其实就是检查-HTTP-请求头部字段的过程，值得注意的一点就是需要针对客户端发送的-Sec-WebSocket-Key-生成一个正确的-Sec-WebSocket-Accept-只。关于生成的-Sec-WebSocket-Accpet-的实现，可以参考之前的分析。握手过程的具体代码如下："><a href="#根据之前的协议分析，我知道握手的过程其实就是检查-HTTP-请求头部字段的过程，值得注意的一点就是需要针对客户端发送的-Sec-WebSocket-Key-生成一个正确的-Sec-WebSocket-Accept-只。关于生成的-Sec-WebSocket-Accpet-的实现，可以参考之前的分析。握手过程的具体代码如下：" class="headerlink" title="根据之前的协议分析，我知道握手的过程其实就是检查 HTTP 请求头部字段的过程，值得注意的一点就是需要针对客户端发送的 Sec-WebSocket-Key 生成一个正确的 Sec-WebSocket-Accept 只。关于生成的 Sec-WebSocket-Accpet 的实现，可以参考之前的分析。握手过程的具体代码如下："></a>根据之前的协议分析，我知道握手的过程其实就是检查 HTTP 请求头部字段的过程，值得注意的一点就是需要针对客户端发送的 <code>Sec-WebSocket-Key</code> 生成一个正确的 <code>Sec-WebSocket-Accept</code> 只。关于生成的 <code>Sec-WebSocket-Accpet</code> 的实现，可以参考之前的分析。握手过程的具体代码如下：</h3><h3 id="upgrade-go"><a href="#upgrade-go" class="headerlink" title="@upgrade.go"></a>@upgrade.go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> websocket</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span>(</span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"net"</span></span><br><span class="line">    <span class="string">"errors"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"bufio"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Upgrade</span><span class="params">(w http.ResponseWriter,r *http.Request)</span><span class="params">(c *Conn,err error)</span></span>&#123;</span><br><span class="line">    <span class="comment">//是否是Get方法</span></span><br><span class="line">    <span class="keyword">if</span> r.Method != <span class="string">"GET"</span> &#123;</span><br><span class="line">        http.Error(w,http.StatusText(http.StatusMethodNotAllowed),http.StatusMethodNotAllowed)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,errors.New(<span class="string">"websocket:method not GET"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//检查 Sec-WebSocket-Version 版本</span></span><br><span class="line">    <span class="keyword">if</span> values := r.Header[<span class="string">"Sec-Websocket-Version"</span>];<span class="built_in">len</span>(values) == <span class="number">0</span> || values[<span class="number">0</span>] != <span class="string">"13"</span> &#123;</span><br><span class="line">        http.Error(w,http.StatusText(http.StatusBadRequest),http.StatusBadRequest)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,errors.New(<span class="string">"websocket:version != 13"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查Connection 和  Upgrade</span></span><br><span class="line">    <span class="keyword">if</span> !tokenListContainsValue(r.Header,<span class="string">"Connection"</span>,<span class="string">"upgrade"</span>) &#123;</span><br><span class="line">        http.Error(w,http.StatusText(http.StatusBadRequest),http.StatusBadRequest)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,errors.New(<span class="string">"websocket:could not find connection header with token 'upgrade'"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> !tokenListContainsValue(r.Header,<span class="string">"Upgrade"</span>,<span class="string">"websocket"</span>) &#123;</span><br><span class="line">        http.Error(w,http.StatusText(http.StatusBadRequest),http.StatusBadRequest)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,errors.New(<span class="string">"websocket:could not find connection header with token 'websocket'"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算Sec-Websocket-Accept的值</span></span><br><span class="line">    challengeKey := r.Header.Get(<span class="string">"Sec-Websocket-Key"</span>)</span><br><span class="line">    <span class="keyword">if</span> challengeKey == <span class="string">""</span> &#123;</span><br><span class="line">        http.Error(w,http.StatusText(http.StatusBadRequest),http.StatusBadRequest)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,errors.New(<span class="string">"websocket:key missing or blank"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        netConn net.Conn</span><br><span class="line">        br *bufio.Reader</span><br><span class="line">    )</span><br><span class="line">    h,ok := w.(http.Hijacker)</span><br><span class="line">    <span class="keyword">if</span>  !ok &#123;</span><br><span class="line">        http.Error(w,http.StatusText(http.StatusInternalServerError),http.StatusInternalServerError)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,errors.New(<span class="string">"websocket:response dose not implement http.Hijacker"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> rw *bufio.ReadWriter</span><br><span class="line">    <span class="comment">//接管当前tcp连接，阻止内置http接管连接</span></span><br><span class="line">    netConn,rw,err = h.Hijack()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        http.Error(w,http.StatusText(http.StatusInternalServerError),http.StatusInternalServerError)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    br = rw.Reader</span><br><span class="line">    <span class="keyword">if</span> br.Buffered() &gt; <span class="number">0</span> &#123;</span><br><span class="line">        netConn.Close()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,errors.New(<span class="string">"websocket:client send data before hanshake is complete"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 构造握手成功后返回的 response</span></span><br><span class="line">    p := []<span class="keyword">byte</span>&#123;&#125;</span><br><span class="line">    p = <span class="built_in">append</span>(p, <span class="string">"HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Accept: "</span>...)</span><br><span class="line">    p = <span class="built_in">append</span>(p, computeAcceptKey(challengeKey)...)</span><br><span class="line">    p = <span class="built_in">append</span>(p, <span class="string">"\r\n\r\n"</span>...)</span><br><span class="line">    <span class="comment">//返回repson 但不关闭连接</span></span><br><span class="line">    <span class="keyword">if</span> _,err = netConn.Write(p);err != <span class="literal">nil</span> &#123;</span><br><span class="line">        netConn.Close()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//升级为websocket</span></span><br><span class="line">    log.Println(<span class="string">"Upgrade http to websocket successfully"</span>)</span><br><span class="line">    conn := newConn(netConn)</span><br><span class="line">    <span class="keyword">return</span> conn,<span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="握手过程的代码比较直观，就不多做解释了。到这里-WebSocket-的实现就基本完成了，可以看到有了之前的各种约定，我们实现-WebSocket-协议也是比较简单的。"><a href="#握手过程的代码比较直观，就不多做解释了。到这里-WebSocket-的实现就基本完成了，可以看到有了之前的各种约定，我们实现-WebSocket-协议也是比较简单的。" class="headerlink" title="握手过程的代码比较直观，就不多做解释了。到这里 WebSocket 的实现就基本完成了，可以看到有了之前的各种约定，我们实现 WebSocket 协议也是比较简单的。"></a>握手过程的代码比较直观，就不多做解释了。到这里 WebSocket 的实现就基本完成了，可以看到有了之前的各种约定，我们实现 WebSocket 协议也是比较简单的。</h3><h2 id="封装的websocket结构体和对应的方法"><a href="#封装的websocket结构体和对应的方法" class="headerlink" title="封装的websocket结构体和对应的方法"></a>封装的websocket结构体和对应的方法</h2><h3 id="conn-go"><a href="#conn-go" class="headerlink" title="@conn.go"></a>@conn.go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> websocket</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"encoding/binary"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"errors"</span></span><br><span class="line">    <span class="string">"net"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 是否是最后一个数据帧</span></span><br><span class="line"><span class="comment">    * Fin Rsv1 Rsv2 Rsv3 Opcode</span></span><br><span class="line"><span class="comment">    *  1  0    0    0    0 0 0 0  =&gt; 128</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    finalBit = <span class="number">1</span> &lt;&lt; <span class="number">7</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 是否需要掩码处理</span></span><br><span class="line"><span class="comment">    *  Mask payload-len 第一位mask表示是否需要进行掩码处理 后面</span></span><br><span class="line"><span class="comment">    *  7位表示数据包长度 1.0-125 表示长度 2.126 后面需要扩展2 字节 16bit</span></span><br><span class="line"><span class="comment">    *  3.127则扩展8bit</span></span><br><span class="line"><span class="comment">    *  1    0 0 0 0 0 0 0  =&gt; 128</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    maskBit = <span class="number">1</span> &lt;&lt; <span class="number">7</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 文本帧类型</span></span><br><span class="line"><span class="comment">    * 0 0 0 0 0 0 0 1</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    TextMessage = <span class="number">1</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 关闭数据帧类型</span></span><br><span class="line"><span class="comment">    * 0 0 0 0 1 0 0 0</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    CloseMessage = <span class="number">8</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//websocket 连接</span></span><br><span class="line"><span class="keyword">type</span> Conn <span class="keyword">struct</span> &#123;</span><br><span class="line">    writeBuf []<span class="keyword">byte</span></span><br><span class="line">    maskKey [<span class="number">4</span>]<span class="keyword">byte</span></span><br><span class="line">    conn net.Conn</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newConn</span><span class="params">(conn net.Conn)</span>*<span class="title">Conn</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;Conn&#123;conn:conn&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Conn)</span><span class="title">Close</span><span class="params">()</span></span>&#123;</span><br><span class="line">    c.conn.Close()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//发送数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Conn)</span><span class="title">SendData</span><span class="params">(data []<span class="keyword">byte</span>)</span></span>&#123;</span><br><span class="line">    length := <span class="built_in">len</span>(data)</span><br><span class="line">    c.writeBuf = <span class="built_in">make</span>([]<span class="keyword">byte</span>,<span class="number">10</span> + length)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据开始和结束位置</span></span><br><span class="line">    payloadStart := <span class="number">2</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    *数据帧的第一个字节，不支持且只能发送文本类型数据</span></span><br><span class="line"><span class="comment">    *finalBit 1 0 0 0 0 0 0 0</span></span><br><span class="line"><span class="comment">    *                |</span></span><br><span class="line"><span class="comment">    *Text     0 0 0 0 0 0 0 1</span></span><br><span class="line"><span class="comment">    * =&gt;      1 0 0 0 0 0 0 1</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    c.writeBuf[<span class="number">0</span>] = <span class="keyword">byte</span>(TextMessage) | finalBit</span><br><span class="line">    fmt.Printf(<span class="string">"1 bit:%b\n"</span>,c.writeBuf[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据帧第二个字节，服务器发送的数据不需要进行掩码处理</span></span><br><span class="line">    <span class="keyword">switch</span>&#123;</span><br><span class="line">    <span class="comment">//大于2字节的长度</span></span><br><span class="line">    <span class="keyword">case</span> length &gt;= <span class="number">1</span> &lt;&lt; <span class="number">16</span> :<span class="comment">//65536</span></span><br><span class="line">        <span class="comment">//c.writeBuf[1] = byte(0x00) | 127 // 127</span></span><br><span class="line">        c.writeBuf[<span class="number">1</span>] = <span class="keyword">byte</span>(<span class="number">127</span>) <span class="comment">// 127</span></span><br><span class="line">        <span class="comment">//大端写入64位</span></span><br><span class="line">        binary.BigEndian.PutUint64(c.writeBuf[payloadStart:],<span class="keyword">uint64</span>(length))</span><br><span class="line">        <span class="comment">//需要8byte来存储数据长度</span></span><br><span class="line">        payloadStart += <span class="number">8</span></span><br><span class="line">    <span class="keyword">case</span> length &gt; <span class="number">125</span>:</span><br><span class="line">        <span class="comment">//c.writeBuf[1] = byte(0x00) | 126</span></span><br><span class="line">        c.writeBuf[<span class="number">1</span>] = <span class="keyword">byte</span>(<span class="number">126</span>)</span><br><span class="line">        binary.BigEndian.PutUint16(c.writeBuf[payloadStart:],<span class="keyword">uint16</span>(length))</span><br><span class="line">        payloadStart += <span class="number">2</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">//c.writeBuf[1] = byte(0x00) | byte(length)</span></span><br><span class="line">        c.writeBuf[<span class="number">1</span>] = <span class="keyword">byte</span>(length)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">"2 bit:%b\n"</span>,c.writeBuf[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="built_in">copy</span>(c.writeBuf[payloadStart:],data[:])</span><br><span class="line">    c.conn.Write(c.writeBuf[:payloadStart+length])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Conn)</span><span class="title">ReadData</span><span class="params">()</span><span class="params">(data []<span class="keyword">byte</span>,err error)</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> b [<span class="number">8</span>]<span class="keyword">byte</span></span><br><span class="line">    <span class="comment">//读取数据帧的前两个字节</span></span><br><span class="line">    <span class="keyword">if</span> _,err := c.conn.Read(b[:<span class="number">2</span>]); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//开始解析第一个字节 是否还有后续数据帧</span></span><br><span class="line">    final := b[<span class="number">0</span>] &amp; finalBit != <span class="number">0</span></span><br><span class="line">    fmt.Printf(<span class="string">"read data 1 bit :%b\n"</span>,b[<span class="number">0</span>])</span><br><span class="line">    <span class="comment">//不支持数据分片</span></span><br><span class="line">    <span class="keyword">if</span> !final &#123;</span><br><span class="line">        log.Println(<span class="string">"Recived fragemented frame,not support"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,errors.New(<span class="string">"not suppeort fragmented message"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据帧类型</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    *1 0 0 0  0 0 0 1</span></span><br><span class="line"><span class="comment">    *        &amp;</span></span><br><span class="line"><span class="comment">    *0 0 0 0  1 1 1 1</span></span><br><span class="line"><span class="comment">    *0 0 0 0  0 0 0 1</span></span><br><span class="line"><span class="comment">    * =&gt; 1 这样就可以直接获取到类型了</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    frameType := <span class="keyword">int</span>(b[<span class="number">0</span>] &amp; <span class="number">0xf</span>)</span><br><span class="line">    <span class="comment">//如果 关闭类型，则关闭连接</span></span><br><span class="line">    <span class="keyword">if</span> frameType == CloseMessage &#123;</span><br><span class="line">        c.conn.Close()</span><br><span class="line">        log.Println(<span class="string">"Recived closed message,connection will be closed"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,errors.New(<span class="string">"recived closed message"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//只实现了文本格式的传输,编码utf-8</span></span><br><span class="line">    <span class="keyword">if</span> frameType != TextMessage &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,errors.New(<span class="string">"only support text message"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//检查数据帧是否被掩码处理</span></span><br><span class="line">    <span class="comment">//maskBit =&gt; 1 0 0 0 0 0 0 0 任何与他 要么为0 要么为 128</span></span><br><span class="line">    mask := b[<span class="number">1</span>] &amp; maskBit != <span class="number">0</span></span><br><span class="line">    <span class="comment">//数据长度</span></span><br><span class="line">    payloadLen := <span class="keyword">int64</span>(b[<span class="number">1</span>] &amp; <span class="number">0x7F</span>)<span class="comment">//0 1 1 1 1 1 1 1 1 127</span></span><br><span class="line">    dataLen := <span class="keyword">int64</span>(payloadLen)</span><br><span class="line">    <span class="comment">//根据payload length 判断数据的真实长度</span></span><br><span class="line">    <span class="keyword">switch</span> payloadLen &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">126</span>:<span class="comment">//扩展2字节</span></span><br><span class="line">        <span class="keyword">if</span> _,err := c.conn.Read(b[:<span class="number">2</span>]);err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>,err</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取扩展二字节的真实数据长度</span></span><br><span class="line">        dataLen = <span class="keyword">int64</span>(binary.BigEndian.Uint16(b[:<span class="number">2</span>]))</span><br><span class="line">    <span class="keyword">case</span> <span class="number">127</span> :</span><br><span class="line">        <span class="keyword">if</span> _,err := c.conn.Read(b[:<span class="number">8</span>]);err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>,err</span><br><span class="line">        &#125;</span><br><span class="line">        dataLen = <span class="keyword">int64</span>(binary.BigEndian.Uint64(b[:<span class="number">8</span>]))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.Printf(<span class="string">"Read data length :%d,payload length %d"</span>,payloadLen,dataLen)</span><br><span class="line">    <span class="comment">//读取mask key</span></span><br><span class="line">    <span class="keyword">if</span> mask &#123;<span class="comment">//如果需要掩码处理的话 需要取出key</span></span><br><span class="line">        <span class="comment">//maskKey 是 4 字节  32位</span></span><br><span class="line">        <span class="keyword">if</span> _,err := c.conn.Read(c.maskKey[:]);err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span> ,err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//读取数据内容</span></span><br><span class="line">    p := <span class="built_in">make</span>([]<span class="keyword">byte</span>,dataLen)</span><br><span class="line">    <span class="keyword">if</span> _,err := c.conn.Read(p);err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> mask &#123;</span><br><span class="line">        maskBytes(c.maskKey,p)<span class="comment">//进行解码</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> p,<span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="http-头部检查"><a href="#http-头部检查" class="headerlink" title="http 头部检查"></a>http 头部检查</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"crypto/sha1"</span></span><br><span class="line">    <span class="string">"encoding/base64"</span></span><br><span class="line">    <span class="string">"strings"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> KeyGUID = []<span class="keyword">byte</span>(<span class="string">"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"</span>)</span><br><span class="line"><span class="comment">//握手阶段使用 加密key返回 进行握手</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">computeAcceptKey</span><span class="params">(challengeKey <span class="keyword">string</span>)</span><span class="title">string</span></span>&#123;</span><br><span class="line">    h := sha1.New()</span><br><span class="line">    h.Write([]<span class="keyword">byte</span>(challengeKey))</span><br><span class="line">    h.Write(KeyGUID)</span><br><span class="line">    <span class="keyword">return</span> base64.StdEncoding.EncodeToString(h.Sum(<span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//解码</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">maskBytes</span><span class="params">(key [4]<span class="keyword">byte</span>,b []<span class="keyword">byte</span>)</span></span>&#123;</span><br><span class="line">    pos := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> b &#123;</span><br><span class="line">        b[i] ^= key[pos &amp; <span class="number">3</span>]</span><br><span class="line">        pos ++</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查http 头部字段中是否包含指定的值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tokenListContainsValue</span><span class="params">(header http.Header, name <span class="keyword">string</span>, value <span class="keyword">string</span>)</span><span class="title">bool</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> _,v := <span class="keyword">range</span> header[name] &#123;</span><br><span class="line">        <span class="keyword">for</span> _, s := <span class="keyword">range</span> strings.Split(v,<span class="string">","</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> strings.EqualFold(value,strings.TrimSpace(s)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;编写基本的httpserver&quot;&gt;&lt;a href=&quot;#编写基本的httpserver&quot; class=&quot;headerlink&quot; title=&quot;编写基本的httpserver&quot;&gt;&lt;/a&gt;编写基本的httpserver&lt;/h2&gt;&lt;h3 id=&quot;启动一个基本的httpse
      
    
    </summary>
    
      <category term="net-protocol" scheme="http://blog.huido.site/categories/net-protocol/"/>
    
      <category term="2.应用层" scheme="http://blog.huido.site/categories/net-protocol/2-%E5%BA%94%E7%94%A8%E5%B1%82/"/>
    
    
      <category term="protocol" scheme="http://blog.huido.site/tags/protocol/"/>
    
      <category term="golang" scheme="http://blog.huido.site/tags/golang/"/>
    
      <category term="websocket" scheme="http://blog.huido.site/tags/websocket/"/>
    
  </entry>
  
  <entry>
    <title>websocket协议解析</title>
    <link href="http://blog.huido.site/wiki/net-protocol/2.%E5%BA%94%E7%94%A8%E5%B1%82/3.websocket%E5%8D%8F%E8%AE%AE%E8%A7%A3%E6%9E%90/"/>
    <id>http://blog.huido.site/wiki/net-protocol/2.应用层/3.websocket协议解析/</id>
    <published>2019-10-21T13:28:59.000Z</published>
    <updated>2019-10-21T07:50:21.779Z</updated>
    
    <content type="html"><![CDATA[<h2 id="websocket-协议报文"><a href="#websocket-协议报文" class="headerlink" title="websocket 协议报文"></a>websocket 协议报文</h2><p>websocket协议也是基于<code>tcp协议</code>，和http不同的是，tcp接受的数据包为<code>二进制帧</code>，而http为<code>字符串数据包</code>。并且websocket协议在连接阶段会触发一个<code>http请求</code>进行websocket协议校验。校验成功后才会接管tcp通讯流程不会断开该http连接</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">websocket 数据帧报文</span><br><span class="line"></span><br><span class="line">  0               1               2               3               4</span><br><span class="line">  0 1 2 3 4 5 6 7 8 1 2 3 4 5 6 7 8 1 2 3 4 5 6 7 8 1 2 3 4 5 6 7 8</span><br><span class="line">  +-+-+-+-+-------+-+-------------+-------------------------------+</span><br><span class="line">  |F|R|R|R| opcode|M| Payload len |    Extended payload length    |</span><br><span class="line">  |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |</span><br><span class="line">  |N|V|V|V|       |S|             |   (if payload len==126/127)   |</span><br><span class="line">  | |1|2|3|       |K|             |                               |</span><br><span class="line">  +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span><br><span class="line">  |     Extended payload length continued, if payload len == 127  |</span><br><span class="line">  + - - - - - - - - - - - - - - - +-------------------------------+</span><br><span class="line">  |                               |Masking-key, if MASK set to 1  |</span><br><span class="line">  +-------------------------------+-------------------------------+</span><br><span class="line">  | Masking-key (continued)       |          Payload Data         |</span><br><span class="line">  +-------------------------------- - - - - - - - - - - - - - - - +</span><br><span class="line">  :                     Payload Data continued ...                :</span><br><span class="line">  + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span><br><span class="line">  |                     Payload Data continued ...                |</span><br><span class="line">  +---------------------------------------------------------------+</span><br></pre></td></tr></table></figure><h2 id="WebSocket协议详解"><a href="#WebSocket协议详解" class="headerlink" title="WebSocket协议详解"></a>WebSocket协议详解</h2><p>WebSocket 协议解决了浏览器和服务器之间的全双工通信问题。在 WebSocket 出现之前，浏览器如果需要从服务器及时获得更新，则需要不停的对服务器主动发起请求，也就是 Web 中常用的poll技术。这样的操作非常低效，这是因为每发起一次新的 HTTP 请求，就需要单独开启一个新的 TCP 链接，同时 HTTP 协议本身也是一种开销非常大的协议。为了解决这些问题，所以出现了 WebSocket 协议。WebSocket 使得浏览器和服务器之间能通过一个持久的 TCP 链接就能完成数据的双向通信。关于 WebSocket 的 RFC 提案，可以参看RFC6455。</p><p>WebSocket 和 HTTP 协议一般情况下都工作在浏览器中，但 WebSocket 是一种完全不同于 HTTP 的协议。尽管，浏览器需要通过 HTTP 协议的GET请求，将 HTTP 协议升级为 WebSocket 协议。升级的过程被称为握手(handshake)。当浏览器和服务器成功握手后，则可以开始根据 WebSocket 定义的通信帧格式开始通信了。像其他各种协议一样，WebSocket 协议的通信帧也分为控制数据帧和普通数据帧，前者用于控制 WebSocket 链接状态，后者用于承载数据。下面我们将一一分析 WebSocket 协议的握手过程以及通信帧格式。</p><h2 id="一、websocket握手"><a href="#一、websocket握手" class="headerlink" title="一、websocket握手"></a>一、websocket握手</h2><h3 id="握手的过程也就是将HTTP协议升级为WebSocket协议的过程，握手开始首先由浏览器端发送一个GET请求，该请求的HTTP头部信息如下"><a href="#握手的过程也就是将HTTP协议升级为WebSocket协议的过程，握手开始首先由浏览器端发送一个GET请求，该请求的HTTP头部信息如下" class="headerlink" title="握手的过程也就是将HTTP协议升级为WebSocket协议的过程，握手开始首先由浏览器端发送一个GET请求，该请求的HTTP头部信息如下:"></a>握手的过程也就是将HTTP协议升级为WebSocket协议的过程，握手开始首先由浏览器端发送一个<code>GET</code>请求，该请求的HTTP头部信息如下:</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/chat</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: server.example.com</span><br><span class="line"><span class="attribute">Upgrade</span>: websocket</span><br><span class="line"><span class="attribute">Connection</span>: Upgrade</span><br><span class="line"><span class="attribute">Sec-WebSocket-Key</span>: dGhlIHNhbXBsZSBub25jZQ==</span><br><span class="line"><span class="attribute">Origin</span>: http://example.com</span><br><span class="line"><span class="attribute">Sec-WebSocket-Protcol</span>: chat, superchat</span><br><span class="line"><span class="attribute">Sec-WebSocket-Version</span>: 13</span><br></pre></td></tr></table></figure><h3 id="当服务器端，成功验证了以上信息后，则会返回一个形如以下的响应："><a href="#当服务器端，成功验证了以上信息后，则会返回一个形如以下的响应：" class="headerlink" title="当服务器端，成功验证了以上信息后，则会返回一个形如以下的响应："></a>当服务器端，成功验证了以上信息后，则会返回一个形如以下的响应：</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">101</span> Switching Protocols</span><br><span class="line"><span class="attribute">Upgrade</span>: websocket</span><br><span class="line"><span class="attribute">Connection</span>: Upgrade</span><br><span class="line"><span class="attribute">Sec-WebSocket-Accept</span>: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</span><br><span class="line"><span class="attribute">Sec-WebSocket-Protocol</span>: chat</span><br></pre></td></tr></table></figure><h3 id="可以看到，浏览器发送端HTTP请求中，增加了一些新端字段，其作用如下所示："><a href="#可以看到，浏览器发送端HTTP请求中，增加了一些新端字段，其作用如下所示：" class="headerlink" title="可以看到，浏览器发送端HTTP请求中，增加了一些新端字段，其作用如下所示："></a>可以看到，浏览器发送端HTTP请求中，增加了一些新端字段，其作用如下所示：</h3><ul><li><code>Upgrade</code>: 规定必需的字段，其值必需为 <code>websocket</code>, 如果不是则握手失败；</li><li><code>Connection</code>: 规定必需的字段，值必需为 <code>Upgrade</code>, 如果不是则握手失败；<br><code>Sec-WebSocket-Key</code>: 必需字段，一个随机的字符串；<br><code>Sec-WebSocket-Protocol</code>: 可选字段，可以用于标识应用层的协议；<br><code>Sec-WebSocket-Version</code>: 必需字段，代表了 WebSocket 协议版本，值必需是 <code>13</code>, 否则握手失败；<h3 id="返回端响应中，如果握手成功会返回状态码101的HTTP响应，同时其他字段说明如下："><a href="#返回端响应中，如果握手成功会返回状态码101的HTTP响应，同时其他字段说明如下：" class="headerlink" title="返回端响应中，如果握手成功会返回状态码101的HTTP响应，同时其他字段说明如下："></a>返回端响应中，如果握手成功会返回状态码<code>101</code>的HTTP响应，同时其他字段说明如下：</h3></li><li><code>Upgrade</code>: 规定必需的字段，其值必需为 <code>websocket</code>, 如果不是则握手失败；</li><li><code>Connection</code>: 规定必需的字段，值必需为 <code>Upgrade</code>, 如果不是则握手失败；</li><li><code>Sec-WebSocket-Accept</code>: 规定必需的字段，该字段的值是通过固定字符串<code>258EAFA5-E914-47DA-95CA-C5AB0DC85B11</code>加上请求中<code>Sec-WebSocket-Key</code>字段的值，然后再对其结果通过 <code>SHA1</code> 哈希算法求出的结果。</li><li><code>Sec-WebSocket-Protocol</code>: 对应于请求中的 <code>Sec-WebSocket-Protocol</code> 字段；<h3 id="当浏览器和服务端成功握手后，就可以传递数据了，传送数据是按照WebSocket的数据格式生成的"><a href="#当浏览器和服务端成功握手后，就可以传递数据了，传送数据是按照WebSocket的数据格式生成的" class="headerlink" title="当浏览器和服务端成功握手后，就可以传递数据了，传送数据是按照WebSocket的数据格式生成的"></a>当浏览器和服务端成功握手后，就可以传递数据了，传送数据是按照WebSocket的数据格式生成的</h3><h2 id="二、WebSocket协议数据帧"><a href="#二、WebSocket协议数据帧" class="headerlink" title="二、WebSocket协议数据帧"></a>二、WebSocket协议数据帧</h2><h3 id="数据帧的定义类似与TCP-IP的格式定义，具体看下图："><a href="#数据帧的定义类似与TCP-IP的格式定义，具体看下图：" class="headerlink" title="数据帧的定义类似与TCP/IP的格式定义，具体看下图："></a>数据帧的定义类似与TCP/IP的格式定义，具体看下图：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> 0                   1                   2                   3</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-------+-+-------------+-------------------------------+</span><br><span class="line">|F|R|R|R| opcode|M| Payload len |    Extended payload length    |</span><br><span class="line">|I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |</span><br><span class="line">|N|V|V|V|       |S|             |   (if payload len==126/127)   |</span><br><span class="line">| |1|2|3|       |K|             |                               |</span><br><span class="line">+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span><br><span class="line">|     Extended payload length continued, if payload len == 127  |</span><br><span class="line">+ - - - - - - - - - - - - - - - +-------------------------------+</span><br><span class="line">|                               |Masking-key, if MASK set to 1  |</span><br><span class="line">+-------------------------------+-------------------------------+</span><br><span class="line">| Masking-key (continued)       |          Payload Data         |</span><br><span class="line">+-------------------------------- - - - - - - - - - - - - - - - +</span><br><span class="line">:                     Payload Data continued ...                :</span><br><span class="line">+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span><br><span class="line">|                     Payload Data continued ...                |</span><br><span class="line">+---------------------------------------------------------------+</span><br></pre></td></tr></table></figure></li></ul><h3 id="以上这张图，一行代表32bit（位），也就是4bytes（字节），总体上包含两份，帧头部和数据内容。每个从WebSocket链接中接受到的数据帧，都要按照以上格式进行解析，这样才能知道该数据帧是用于控制的还是用于传送数据的，关于以上数据帧的各个比特位的解释如下："><a href="#以上这张图，一行代表32bit（位），也就是4bytes（字节），总体上包含两份，帧头部和数据内容。每个从WebSocket链接中接受到的数据帧，都要按照以上格式进行解析，这样才能知道该数据帧是用于控制的还是用于传送数据的，关于以上数据帧的各个比特位的解释如下：" class="headerlink" title="以上这张图，一行代表32bit（位），也就是4bytes（字节），总体上包含两份，帧头部和数据内容。每个从WebSocket链接中接受到的数据帧，都要按照以上格式进行解析，这样才能知道该数据帧是用于控制的还是用于传送数据的，关于以上数据帧的各个比特位的解释如下："></a>以上这张图，一行代表32bit（位），也就是4bytes（字节），总体上包含两份，帧头部和数据内容。每个从WebSocket链接中接受到的数据帧，都要按照以上格式进行解析，这样才能知道该数据帧是用于控制的还是用于传送数据的，关于以上数据帧的各个比特位的解释如下：</h3><ul><li><code>FIN</code>:1bit,当该比特位值为%x0时，表示后面还有更多的数据帧，%x1时表示这是最后一个数据帧；</li><li><code>RSV1</code>,<code>RSV2</code>,<code>RSV3</code>:各占1个比特位。一般情况下全为0，当客户端、服务端协商采用WebSocket扩展时，这三个标识位可以非0，且值当含义由扩展进行定义，如果出现非0当值，且没有采用WebSocket扩展，则链接出错</li><li><code>opcode</code>:4 bit,用于表明数据帧当类型，一共可以表示16种帧类型，如下所示：<ul><li>%x0:表示这是一个分片当帧，它属于前面帧当后续帧；</li><li>%x1:表示该数据帧携带的数据类型是文本类型，且编码utf-8</li><li>%x2 : 表示携带的是二进制数据；</li><li>%x3-7 : 保留未使用；</li><li>%x8 : 表示该帧用于关闭 WebSocket 链接；</li><li>%x9 : 表示该帧代表了 ping 操作；</li><li>%xA : 表示该帧代表了 pong 回应；</li><li>%xB-F : 保留未使用；</li></ul></li><li><code>MASK</code>:1 bit,%x0表示数据帧没有经过掩码计算，而%x1则表示数据帧已经经过掩码计算，得到真正当数据需要解码，一般情况下，只有浏览器发送给服务端当数据帧才需要进行掩码计算；</li><li><code>Payload len</code>:7 bit,表示了数据帧携带当数据长度，7 bit 的值根据三种情况，帧的解析有所不同：<ul><li>%x0 - 7D : 也就是从 0 到 125，表示数据长度, 数据总长度也就是 7 bit 代表的长度；</li><li>%x7E : 7 bit 的值是 126 时，则后续的 2 个字节（16 bit)表示的一个 16 位无符号数，这个数用来表示数据的长度；</li><li>%x7F : 7 bit 的值是 127 时，则后续的 8 个字节（64 bit)表示的一个 64 位无符号数，这个数用来表示数据的长度；<ul><li><code>Masking-key</code>: 32 bit, 表示了用于解码的 key，只有当 MASK 比特位的值为 %x1 是，才有该数据；   </li></ul></li></ul></li><li><code>Payload Data</code>: 余下的比特位用于存储具体的数据；<h3 id="通过以上分析可以看出，WebSocket-协议数据帧的最大头部为-2-8-4-14-bytes-也就是-14-个字节。同时我们要实现-WebSocket-协议，最主要的工作就是实现对数据帧的解析。"><a href="#通过以上分析可以看出，WebSocket-协议数据帧的最大头部为-2-8-4-14-bytes-也就是-14-个字节。同时我们要实现-WebSocket-协议，最主要的工作就是实现对数据帧的解析。" class="headerlink" title="通过以上分析可以看出，WebSocket 协议数据帧的最大头部为 2 + 8 + 4 = 14 bytes 也就是 14 个字节。同时我们要实现 WebSocket 协议，最主要的工作就是实现对数据帧的解析。"></a>通过以上分析可以看出，WebSocket 协议数据帧的最大头部为 2 + 8 + 4 = 14 bytes 也就是 14 个字节。同时我们要实现 WebSocket 协议，最主要的工作就是实现对数据帧的解析。</h3></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;websocket-协议报文&quot;&gt;&lt;a href=&quot;#websocket-协议报文&quot; class=&quot;headerlink&quot; title=&quot;websocket 协议报文&quot;&gt;&lt;/a&gt;websocket 协议报文&lt;/h2&gt;&lt;p&gt;websocket协议也是基于&lt;code&gt;t
      
    
    </summary>
    
      <category term="net-protocol" scheme="http://blog.huido.site/categories/net-protocol/"/>
    
      <category term="2.应用层" scheme="http://blog.huido.site/categories/net-protocol/2-%E5%BA%94%E7%94%A8%E5%B1%82/"/>
    
    
      <category term="protocol" scheme="http://blog.huido.site/tags/protocol/"/>
    
      <category term="golang" scheme="http://blog.huido.site/tags/golang/"/>
    
      <category term="websocket" scheme="http://blog.huido.site/tags/websocket/"/>
    
  </entry>
  
  <entry>
    <title>http协议解析</title>
    <link href="http://blog.huido.site/wiki/net-protocol/4.%E7%BD%91%E7%BB%9C%E5%B1%82/2.http%E5%8D%8F%E8%AE%AE%E8%A7%A3%E6%9E%90/"/>
    <id>http://blog.huido.site/wiki/net-protocol/4.网络层/2.http协议解析/</id>
    <published>2019-10-18T13:28:59.000Z</published>
    <updated>2019-10-21T07:50:21.779Z</updated>
    
    <content type="html"><![CDATA[<h2 id="http-报文协议"><a href="#http-报文协议" class="headerlink" title="http 报文协议"></a>http 报文协议</h2>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;http-报文协议&quot;&gt;&lt;a href=&quot;#http-报文协议&quot; class=&quot;headerlink&quot; title=&quot;http 报文协议&quot;&gt;&lt;/a&gt;http 报文协议&lt;/h2&gt;
      
    
    </summary>
    
      <category term="net-protocol" scheme="http://blog.huido.site/categories/net-protocol/"/>
    
      <category term="4.网络层" scheme="http://blog.huido.site/categories/net-protocol/4-%E7%BD%91%E7%BB%9C%E5%B1%82/"/>
    
    
      <category term="Go" scheme="http://blog.huido.site/tags/Go/"/>
    
      <category term="Protocol" scheme="http://blog.huido.site/tags/Protocol/"/>
    
  </entry>
  
  <entry>
    <title>http协议解析</title>
    <link href="http://blog.huido.site/wiki/net-protocol/2.%E5%BA%94%E7%94%A8%E5%B1%82/2.http%E5%8D%8F%E8%AE%AE%E8%A7%A3%E6%9E%90/"/>
    <id>http://blog.huido.site/wiki/net-protocol/2.应用层/2.http协议解析/</id>
    <published>2019-10-18T13:28:59.000Z</published>
    <updated>2019-10-21T07:50:21.779Z</updated>
    
    <content type="html"><![CDATA[<h2 id="http协议报文"><a href="#http协议报文" class="headerlink" title="http协议报文"></a>http协议报文</h2><p>这是一个典型的http请求的报文样例，可以看出是一个websocket升级前的http请求。该字符报文完全基于<code>tcp协议</code>，协议报文内容为<code>tcp数据包</code>，也就是<code>tcp</code>进行<code>recv</code>调用获取的数据内容。如下报文表示已经接受完http报文数据。</p><p>解析http报文的源码为<code>application/http/request.go</code>中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http 协议报文</span><br><span class="line">GET /chat HTTP/1.1</span><br><span class="line">Host: server.example.com</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==</span><br><span class="line">Origin: http://example.com</span><br><span class="line">Sec-WebSocket-Protcol: chat, superchat</span><br><span class="line">Sec-WebSocket-Version: 13</span><br></pre></td></tr></table></figure></p><h3 id="请求方法"><a href="#请求方法" class="headerlink" title="@请求方法"></a>@请求方法</h3><p>解析tcp数据包第一行数据，遇到<code></code>空格就拆分，则获取到请求方法</p><h3 id="uri"><a href="#uri" class="headerlink" title="@uri"></a>@uri</h3><p>解析tcp数据包第一行数据，遇到<code></code>空格就拆分，则获取到uri路径</p><h3 id="header头部"><a href="#header头部" class="headerlink" title="@header头部"></a>@header头部</h3><p>接下来都是一些头部信息的keyvalue，每次读取一行，然后根据:分隔符进行拆分，获取header头部请求键值对</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;http协议报文&quot;&gt;&lt;a href=&quot;#http协议报文&quot; class=&quot;headerlink&quot; title=&quot;http协议报文&quot;&gt;&lt;/a&gt;http协议报文&lt;/h2&gt;&lt;p&gt;这是一个典型的http请求的报文样例，可以看出是一个websocket升级前的http请求。
      
    
    </summary>
    
      <category term="net-protocol" scheme="http://blog.huido.site/categories/net-protocol/"/>
    
      <category term="2.应用层" scheme="http://blog.huido.site/categories/net-protocol/2-%E5%BA%94%E7%94%A8%E5%B1%82/"/>
    
    
      <category term="protocol" scheme="http://blog.huido.site/tags/protocol/"/>
    
      <category term="golang" scheme="http://blog.huido.site/tags/golang/"/>
    
      <category term="http" scheme="http://blog.huido.site/tags/http/"/>
    
  </entry>
  
  <entry>
    <title>http协议解析</title>
    <link href="http://blog.huido.site/wiki/net-protocol/5.%E9%93%BE%E8%B7%AF%E5%B1%82/2.http%E5%8D%8F%E8%AE%AE%E8%A7%A3%E6%9E%90/"/>
    <id>http://blog.huido.site/wiki/net-protocol/5.链路层/2.http协议解析/</id>
    <published>2019-10-18T13:28:59.000Z</published>
    <updated>2019-10-21T07:50:21.779Z</updated>
    
    <content type="html"><![CDATA[<h2 id="http-报文协议"><a href="#http-报文协议" class="headerlink" title="http 报文协议"></a>http 报文协议</h2>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;http-报文协议&quot;&gt;&lt;a href=&quot;#http-报文协议&quot; class=&quot;headerlink&quot; title=&quot;http 报文协议&quot;&gt;&lt;/a&gt;http 报文协议&lt;/h2&gt;
      
    
    </summary>
    
      <category term="net-protocol" scheme="http://blog.huido.site/categories/net-protocol/"/>
    
      <category term="5.链路层" scheme="http://blog.huido.site/categories/net-protocol/5-%E9%93%BE%E8%B7%AF%E5%B1%82/"/>
    
    
      <category term="Go" scheme="http://blog.huido.site/tags/Go/"/>
    
      <category term="Protocol" scheme="http://blog.huido.site/tags/Protocol/"/>
    
  </entry>
  
  <entry>
    <title>http协议解析</title>
    <link href="http://blog.huido.site/wiki/net-protocol/6.%E7%89%A9%E7%90%86%E5%B1%82/2.http%E5%8D%8F%E8%AE%AE%E8%A7%A3%E6%9E%90/"/>
    <id>http://blog.huido.site/wiki/net-protocol/6.物理层/2.http协议解析/</id>
    <published>2019-10-18T13:28:59.000Z</published>
    <updated>2019-10-21T07:50:21.779Z</updated>
    
    <content type="html"><![CDATA[<h2 id="http-报文协议"><a href="#http-报文协议" class="headerlink" title="http 报文协议"></a>http 报文协议</h2>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;http-报文协议&quot;&gt;&lt;a href=&quot;#http-报文协议&quot; class=&quot;headerlink&quot; title=&quot;http 报文协议&quot;&gt;&lt;/a&gt;http 报文协议&lt;/h2&gt;
      
    
    </summary>
    
      <category term="net-protocol" scheme="http://blog.huido.site/categories/net-protocol/"/>
    
      <category term="6.物理层" scheme="http://blog.huido.site/categories/net-protocol/6-%E7%89%A9%E7%90%86%E5%B1%82/"/>
    
    
      <category term="Go" scheme="http://blog.huido.site/tags/Go/"/>
    
      <category term="Protocol" scheme="http://blog.huido.site/tags/Protocol/"/>
    
  </entry>
  
  <entry>
    <title>应用层前世今生</title>
    <link href="http://blog.huido.site/wiki/net-protocol/2.%E5%BA%94%E7%94%A8%E5%B1%82/1.%E5%BA%94%E7%94%A8%E5%B1%82%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/"/>
    <id>http://blog.huido.site/wiki/net-protocol/2.应用层/1.应用层前世今生/</id>
    <published>2019-10-17T13:28:59.000Z</published>
    <updated>2019-10-21T07:50:21.779Z</updated>
    
    <content type="html"><![CDATA[<h2 id="应用层的作用"><a href="#应用层的作用" class="headerlink" title="应用层的作用"></a>应用层的作用</h2><p>对传输层协议对再次封装，例如对tcp进行封装对http、websocket协议等，以及http3协议基于udp协议的封装等</p><h2 id="http协议报文"><a href="#http协议报文" class="headerlink" title="http协议报文"></a>http协议报文</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http 协议报文</span><br><span class="line">GET /chat HTTP/1.1</span><br><span class="line">Host: server.example.com</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==</span><br><span class="line">Origin: http://example.com</span><br><span class="line">Sec-WebSocket-Protcol: chat, superchat</span><br><span class="line">Sec-WebSocket-Version: 13</span><br></pre></td></tr></table></figure><h2 id="websocket-协议报文"><a href="#websocket-协议报文" class="headerlink" title="websocket 协议报文"></a>websocket 协议报文</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">websocket 数据帧报文</span><br><span class="line"></span><br><span class="line">  0               1               2               3               4</span><br><span class="line">  0 1 2 3 4 5 6 7 8 1 2 3 4 5 6 7 8 1 2 3 4 5 6 7 8 1 2 3 4 5 6 7 8</span><br><span class="line">  +-+-+-+-+-------+-+-------------+-------------------------------+</span><br><span class="line">  |F|R|R|R| opcode|M| Payload len |    Extended payload length    |</span><br><span class="line">  |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |</span><br><span class="line">  |N|V|V|V|       |S|             |   (if payload len==126/127)   |</span><br><span class="line">  | |1|2|3|       |K|             |                               |</span><br><span class="line">  +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span><br><span class="line">  |     Extended payload length continued, if payload len == 127  |</span><br><span class="line">  + - - - - - - - - - - - - - - - +-------------------------------+</span><br><span class="line">  |                               |Masking-key, if MASK set to 1  |</span><br><span class="line">  +-------------------------------+-------------------------------+</span><br><span class="line">  | Masking-key (continued)       |          Payload Data         |</span><br><span class="line">  +-------------------------------- - - - - - - - - - - - - - - - +</span><br><span class="line">  :                     Payload Data continued ...                :</span><br><span class="line">  + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span><br><span class="line">  |                     Payload Data continued ...                |</span><br><span class="line">  +---------------------------------------------------------------+</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;应用层的作用&quot;&gt;&lt;a href=&quot;#应用层的作用&quot; class=&quot;headerlink&quot; title=&quot;应用层的作用&quot;&gt;&lt;/a&gt;应用层的作用&lt;/h2&gt;&lt;p&gt;对传输层协议对再次封装，例如对tcp进行封装对http、websocket协议等，以及http3协议基于ud
      
    
    </summary>
    
      <category term="net-protocol" scheme="http://blog.huido.site/categories/net-protocol/"/>
    
      <category term="2.应用层" scheme="http://blog.huido.site/categories/net-protocol/2-%E5%BA%94%E7%94%A8%E5%B1%82/"/>
    
    
      <category term="go" scheme="http://blog.huido.site/tags/go/"/>
    
      <category term="protocol" scheme="http://blog.huido.site/tags/protocol/"/>
    
  </entry>
  
  <entry>
    <title>应用层前世今生</title>
    <link href="http://blog.huido.site/wiki/net-protocol/3.%E4%BC%A0%E8%BE%93%E5%B1%82/1.%E5%BA%94%E7%94%A8%E5%B1%82%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/"/>
    <id>http://blog.huido.site/wiki/net-protocol/3.传输层/1.应用层前世今生/</id>
    <published>2019-10-17T13:28:59.000Z</published>
    <updated>2019-10-21T07:50:21.779Z</updated>
    
    <content type="html"><![CDATA[<h2 id="应用层的作用"><a href="#应用层的作用" class="headerlink" title="应用层的作用"></a>应用层的作用</h2><p>对传输层协议对再次封装，例如对tcp进行封装对http、websocket协议等，以及http3协议基于udp协议的封装等</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;应用层的作用&quot;&gt;&lt;a href=&quot;#应用层的作用&quot; class=&quot;headerlink&quot; title=&quot;应用层的作用&quot;&gt;&lt;/a&gt;应用层的作用&lt;/h2&gt;&lt;p&gt;对传输层协议对再次封装，例如对tcp进行封装对http、websocket协议等，以及http3协议基于ud
      
    
    </summary>
    
      <category term="net-protocol" scheme="http://blog.huido.site/categories/net-protocol/"/>
    
      <category term="3.传输层" scheme="http://blog.huido.site/categories/net-protocol/3-%E4%BC%A0%E8%BE%93%E5%B1%82/"/>
    
    
      <category term="Go" scheme="http://blog.huido.site/tags/Go/"/>
    
      <category term="Protocol" scheme="http://blog.huido.site/tags/Protocol/"/>
    
  </entry>
  
  <entry>
    <title>应用层前世今生</title>
    <link href="http://blog.huido.site/wiki/net-protocol/5.%E9%93%BE%E8%B7%AF%E5%B1%82/1.%E5%BA%94%E7%94%A8%E5%B1%82%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/"/>
    <id>http://blog.huido.site/wiki/net-protocol/5.链路层/1.应用层前世今生/</id>
    <published>2019-10-17T13:28:59.000Z</published>
    <updated>2019-10-21T07:50:21.779Z</updated>
    
    <content type="html"><![CDATA[<h2 id="应用层的作用"><a href="#应用层的作用" class="headerlink" title="应用层的作用"></a>应用层的作用</h2><p>对传输层协议对再次封装，例如对tcp进行封装对http、websocket协议等，以及http3协议基于udp协议的封装等</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;应用层的作用&quot;&gt;&lt;a href=&quot;#应用层的作用&quot; class=&quot;headerlink&quot; title=&quot;应用层的作用&quot;&gt;&lt;/a&gt;应用层的作用&lt;/h2&gt;&lt;p&gt;对传输层协议对再次封装，例如对tcp进行封装对http、websocket协议等，以及http3协议基于ud
      
    
    </summary>
    
      <category term="net-protocol" scheme="http://blog.huido.site/categories/net-protocol/"/>
    
      <category term="5.链路层" scheme="http://blog.huido.site/categories/net-protocol/5-%E9%93%BE%E8%B7%AF%E5%B1%82/"/>
    
    
      <category term="Go" scheme="http://blog.huido.site/tags/Go/"/>
    
      <category term="Protocol" scheme="http://blog.huido.site/tags/Protocol/"/>
    
  </entry>
  
  <entry>
    <title>应用层前世今生</title>
    <link href="http://blog.huido.site/wiki/net-protocol/6.%E7%89%A9%E7%90%86%E5%B1%82/1.%E5%BA%94%E7%94%A8%E5%B1%82%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/"/>
    <id>http://blog.huido.site/wiki/net-protocol/6.物理层/1.应用层前世今生/</id>
    <published>2019-10-17T13:28:59.000Z</published>
    <updated>2019-10-21T07:50:21.779Z</updated>
    
    <content type="html"><![CDATA[<h2 id="应用层的作用"><a href="#应用层的作用" class="headerlink" title="应用层的作用"></a>应用层的作用</h2><p>对传输层协议对再次封装，例如对tcp进行封装对http、websocket协议等，以及http3协议基于udp协议的封装等</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;应用层的作用&quot;&gt;&lt;a href=&quot;#应用层的作用&quot; class=&quot;headerlink&quot; title=&quot;应用层的作用&quot;&gt;&lt;/a&gt;应用层的作用&lt;/h2&gt;&lt;p&gt;对传输层协议对再次封装，例如对tcp进行封装对http、websocket协议等，以及http3协议基于ud
      
    
    </summary>
    
      <category term="net-protocol" scheme="http://blog.huido.site/categories/net-protocol/"/>
    
      <category term="6.物理层" scheme="http://blog.huido.site/categories/net-protocol/6-%E7%89%A9%E7%90%86%E5%B1%82/"/>
    
    
      <category term="Go" scheme="http://blog.huido.site/tags/Go/"/>
    
      <category term="Protocol" scheme="http://blog.huido.site/tags/Protocol/"/>
    
  </entry>
  
  <entry>
    <title>快速开始</title>
    <link href="http://blog.huido.site/wiki/net-protocol/1.%E5%89%8D%E8%A8%80/1.%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/"/>
    <id>http://blog.huido.site/wiki/net-protocol/1.前言/1.快速开始/</id>
    <published>2019-10-16T13:28:59.000Z</published>
    <updated>2019-10-21T07:50:21.779Z</updated>
    
    <content type="html"><![CDATA[<h2 id="demo案例"><a href="#demo案例" class="headerlink" title="demo案例"></a>demo案例</h2><p><code>cmd</code>:该目录下为各协议的实现demo，提供api调用实现以及测试</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;demo案例&quot;&gt;&lt;a href=&quot;#demo案例&quot; class=&quot;headerlink&quot; title=&quot;demo案例&quot;&gt;&lt;/a&gt;demo案例&lt;/h2&gt;&lt;p&gt;&lt;code&gt;cmd&lt;/code&gt;:该目录下为各协议的实现demo，提供api调用实现以及测试&lt;/p&gt;

      
    
    </summary>
    
      <category term="net-protocol" scheme="http://blog.huido.site/categories/net-protocol/"/>
    
      <category term="1.前言" scheme="http://blog.huido.site/categories/net-protocol/1-%E5%89%8D%E8%A8%80/"/>
    
    
      <category term="Go" scheme="http://blog.huido.site/tags/Go/"/>
    
      <category term="Protocol" scheme="http://blog.huido.site/tags/Protocol/"/>
    
  </entry>
  
  <entry>
    <title>内核协议栈</title>
    <link href="http://blog.huido.site/wiki/net-protocol/%E5%86%85%E6%A0%B8%E5%8D%8F%E8%AE%AE%E6%A0%88/"/>
    <id>http://blog.huido.site/wiki/net-protocol/内核协议栈/</id>
    <published>2017-10-24T13:28:59.000Z</published>
    <updated>2019-10-21T07:50:21.779Z</updated>
    
    <content type="html"><![CDATA[<h1 id="net-protocol"><a href="#net-protocol" class="headerlink" title="net-protocol"></a>net-protocol</h1><p><img alt="GitHub last commit" src="https://img.shields.io/github/last-commit/brewlin/net-protocol"><br><img alt="GitHub" src="https://img.shields.io/github/license/brewlin/net-protocol"><br><img alt="GitHub code size in bytes" src="https://img.shields.io/github/languages/code-size/brewlin/net-protocol"><br>  <img alt="GitHub release (latest by date)" src="https://img.shields.io/github/v/release/brewlin/net-protocol"><br>  </p></p><p>基于go 实现链路层、网络层、传输层、应用层 网络协议栈 ，使用虚拟网卡实现</p><h2 id="docs"><a href="#docs" class="headerlink" title="@docs"></a>@docs</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">相关md文档在cmd目录下，以及相关协议的demo测试</span><br></pre></td></tr></table></figure><p><code>./cmd/*.md</code></p><h2 id="application-应用层"><a href="#application-应用层" class="headerlink" title="@application 应用层"></a>@application 应用层</h2><ul><li style="list-style: none"><input type="checkbox" checked></input> http <a href="./cmd/http.md">docs</a></li><li style="list-style: none"><input type="checkbox" checked></input> websocket <a href="./cmd/websocket.md">docs</a></li></ul><h2 id="transport-传输层"><a href="#transport-传输层" class="headerlink" title="@transport 传输层"></a>@transport 传输层</h2><ul><li style="list-style: none"><input type="checkbox" checked></input> tcp <a href="./cmd/tcp.md">docs</a></li><li style="list-style: none"><input type="checkbox" checked></input> udp <a href="./cmd/udp.md">docs</a></li><li style="list-style: none"><input type="checkbox" checked></input> port 端口机制</li></ul><h2 id="network-网络层"><a href="#network-网络层" class="headerlink" title="@network 网络层"></a>@network 网络层</h2><ul><li style="list-style: none"><input type="checkbox" checked></input> icmp</li><li style="list-style: none"><input type="checkbox" checked></input> ipv4</li><li style="list-style: none"><input type="checkbox" checked></input> ipv6</li></ul><h2 id="link-链路层"><a href="#link-链路层" class="headerlink" title="@link 链路层"></a>@link 链路层</h2><ul><li style="list-style: none"><input type="checkbox" checked></input> arp <a href="./cmd/arp.md">docs</a></li><li style="list-style: none"><input type="checkbox" checked></input> ethernet</li></ul><h2 id="物理层"><a href="#物理层" class="headerlink" title="@物理层"></a>@物理层</h2><ul><li style="list-style: none"><input type="checkbox" checked></input> tun tap 虚拟网卡的实现</li></ul><h2 id="协议相关api"><a href="#协议相关api" class="headerlink" title="协议相关api"></a>协议相关api</h2><h3 id="1-应用层相关协议"><a href="#1-应用层相关协议" class="headerlink" title="1.应用层相关协议"></a>1.应用层相关协议</h3><p>应用层暂时只实现了<code>http</code>、<code>websocket</code>等文本协议。都基于tcp、对tcp等进行二次封装</p><p><a href="./http-api.md">http api</a> :<code>http-api.md</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http 协议报文</span><br><span class="line">GET /chat HTTP/1.1</span><br><span class="line">Host: server.example.com</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==</span><br><span class="line">Origin: http://example.com</span><br><span class="line">Sec-WebSocket-Protcol: chat, superchat</span><br><span class="line">Sec-WebSocket-Version: 13</span><br></pre></td></tr></table></figure></p><p><a href="./websocket-api.md">websocket api</a> : <code>websocket-api.md</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">websocket 数据帧报文</span><br><span class="line"></span><br><span class="line">  0               1               2               3               4</span><br><span class="line">  0 1 2 3 4 5 6 7 8 1 2 3 4 5 6 7 8 1 2 3 4 5 6 7 8 1 2 3 4 5 6 7 8</span><br><span class="line">  +-+-+-+-+-------+-+-------------+-------------------------------+</span><br><span class="line">  |F|R|R|R| opcode|M| Payload len |    Extended payload length    |</span><br><span class="line">  |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |</span><br><span class="line">  |N|V|V|V|       |S|             |   (if payload len==126/127)   |</span><br><span class="line">  | |1|2|3|       |K|             |                               |</span><br><span class="line">  +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span><br><span class="line">  |     Extended payload length continued, if payload len == 127  |</span><br><span class="line">  + - - - - - - - - - - - - - - - +-------------------------------+</span><br><span class="line">  |                               |Masking-key, if MASK set to 1  |</span><br><span class="line">  +-------------------------------+-------------------------------+</span><br><span class="line">  | Masking-key (continued)       |          Payload Data         |</span><br><span class="line">  +-------------------------------- - - - - - - - - - - - - - - - +</span><br><span class="line">  :                     Payload Data continued ...                :</span><br><span class="line">  + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span><br><span class="line">  |                     Payload Data continued ...                |</span><br><span class="line">  +---------------------------------------------------------------+</span><br></pre></td></tr></table></figure></p><h3 id="2-传输层相关协议"><a href="#2-传输层相关协议" class="headerlink" title="2.传输层相关协议"></a>2.传输层相关协议</h3><p>传输层实现了<code>upd</code>、<code>tcp</code>、灯协议，并实现了主要接口</p><p><a href="./tcp-api.md">tcp api</a>:<code>tcp-api.md</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">     tcp 首部协议报文</span><br><span class="line">0               1               2               3               4</span><br><span class="line">0 1 2 3 4 5 6 7 8 1 2 3 4 5 6 7 8 1 2 3 4 5 6 7 8 1 2 3 4 5 6 7 8</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|          Source Port          |       Destination Port        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                        Sequence Number                        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Acknowledgment Number                      |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|  Data |           |U|A|P|R|S|F|                               |</span><br><span class="line">| Offset| Reserved  |R|C|S|S|Y|I|            Window             |</span><br><span class="line">|       |           |G|K|H|T|N|N|                               |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|           Checksum            |         Urgent Pointer        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Options                    |    Padding    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                             data                              |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure><p><a href="./udp-api.md">udp-api</a>:<code>./udp-api.md</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">udp 协议报文</span><br></pre></td></tr></table></figure></p><p>端口机制</p><h3 id="3-网络层相关协议"><a href="#3-网络层相关协议" class="headerlink" title="3.网络层相关协议"></a>3.网络层相关协议</h3><p><a href="./ipv-api.md">ip</a>:<code>ipv4-api.md</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">              ip头部协议报文</span><br><span class="line">0               1               2               3               4</span><br><span class="line">0 1 2 3 4 5 6 7 8 1 2 3 4 5 6 7 8 1 2 3 4 5 6 7 8 1 2 3 4 5 6 7 8</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|Version|  LHL  | Type of Service |        Total Length         |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|  Identification(fragment Id)    |Flags|  Fragment Offset      |</span><br><span class="line">|           16 bits               |R|D|M|       13 bits         |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">| Time-To-Live  |   Protocol      |      Header Checksum        |</span><br><span class="line">| ttl(8 bits)   |    8 bits       |          16 bits            |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|               Source IP Address (32 bits)                     |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|              Destination Ip Address (32 bits)                 |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Options (*** bits)          |  Padding     |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;net-protocol&quot;&gt;&lt;a href=&quot;#net-protocol&quot; class=&quot;headerlink&quot; title=&quot;net-protocol&quot;&gt;&lt;/a&gt;net-protocol&lt;/h1&gt;&lt;p&gt;&lt;img alt=&quot;GitHub last commit&quot; 
      
    
    </summary>
    
      <category term="net-protocol" scheme="http://blog.huido.site/categories/net-protocol/"/>
    
    
      <category term="Go" scheme="http://blog.huido.site/tags/Go/"/>
    
      <category term="Protocol" scheme="http://blog.huido.site/tags/Protocol/"/>
    
  </entry>
  
  <entry>
    <title>微服务应用</title>
    <link href="http://blog.huido.site/wiki/swoft-im/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BA%94%E7%94%A8/"/>
    <id>http://blog.huido.site/wiki/swoft-im/微服务应用/</id>
    <published>2017-10-24T13:28:59.000Z</published>
    <updated>2019-10-21T07:50:21.779Z</updated>
    
    <summary type="html">
    
    </summary>
    
      <category term="swoft-im" scheme="http://blog.huido.site/categories/swoft-im/"/>
    
    
      <category term="PHP" scheme="http://blog.huido.site/tags/PHP/"/>
    
      <category term="Swoole" scheme="http://blog.huido.site/tags/Swoole/"/>
    
      <category term="IM" scheme="http://blog.huido.site/tags/IM/"/>
    
  </entry>
  
  <entry>
    <title>GO标准库和算法应用</title>
    <link href="http://blog.huido.site/wiki/go-stl/GO%E6%A0%87%E5%87%86%E5%BA%93%E5%92%8C%E7%AE%97%E6%B3%95%E5%BA%94%E7%94%A8/"/>
    <id>http://blog.huido.site/wiki/go-stl/GO标准库和算法应用/</id>
    <published>2017-10-24T13:28:59.000Z</published>
    <updated>2019-10-21T07:50:21.779Z</updated>
    
    <content type="html"><![CDATA[<h1 id="go-stl"><a href="#go-stl" class="headerlink" title="go-stl"></a>go-stl</h1><p>todo..</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;go-stl&quot;&gt;&lt;a href=&quot;#go-stl&quot; class=&quot;headerlink&quot; title=&quot;go-stl&quot;&gt;&lt;/a&gt;go-stl&lt;/h1&gt;&lt;p&gt;todo..&lt;/p&gt;

      
    
    </summary>
    
      <category term="go-stl" scheme="http://blog.huido.site/categories/go-stl/"/>
    
    
      <category term="Go" scheme="http://blog.huido.site/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title>分布式推送中间件</title>
    <link href="http://blog.huido.site/wiki/im-cloud/%E5%88%86%E5%B8%83%E5%BC%8F%E6%8E%A8%E9%80%81%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    <id>http://blog.huido.site/wiki/im-cloud/分布式推送中间件/</id>
    <published>2017-10-24T13:28:59.000Z</published>
    <updated>2019-10-21T07:50:21.779Z</updated>
    
    <content type="html"><![CDATA[<h1 id="im-cloud"><a href="#im-cloud" class="headerlink" title="im-cloud"></a>im-cloud</h1>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;im-cloud&quot;&gt;&lt;a href=&quot;#im-cloud&quot; class=&quot;headerlink&quot; title=&quot;im-cloud&quot;&gt;&lt;/a&gt;im-cloud&lt;/h1&gt;
      
    
    </summary>
    
      <category term="im-cloud" scheme="http://blog.huido.site/categories/im-cloud/"/>
    
    
      <category term="PHP" scheme="http://blog.huido.site/tags/PHP/"/>
    
      <category term="Swoole" scheme="http://blog.huido.site/tags/Swoole/"/>
    
      <category term="RabbitMQ" scheme="http://blog.huido.site/tags/RabbitMQ/"/>
    
  </entry>
  
  <entry>
    <title>Welcome Brewlin&#39;s Wiki Site</title>
    <link href="http://blog.huido.site/wiki/index/"/>
    <id>http://blog.huido.site/wiki/index/</id>
    <published>2017-01-21T17:55:57.000Z</published>
    <updated>2019-10-21T07:50:21.779Z</updated>
    
    <content type="html"><![CDATA[<h2 id="net-protocol"><a href="#net-protocol" class="headerlink" title="@net-protocol"></a>@net-protocol</h2><p>基于go模拟内核协议栈 实现链路层、网络层、传输层、应用层 网络协议栈 ，使用虚拟网卡实现</p><h2 id="go-stl"><a href="#go-stl" class="headerlink" title="@go-stl"></a>@go-stl</h2><p>Golang Standard Template Library</p><h2 id="im-cloud"><a href="#im-cloud" class="headerlink" title="@im-cloud"></a>@im-cloud</h2><p>原生swoole4 全协程化分布式中间件、多节点扩容、多节点服务</p><h2 id="swoft-im"><a href="#swoft-im" class="headerlink" title="@swoft-im"></a>@swoft-im</h2><p>基于swoft-cloud的微服务架构，最小化拆分粒度，PHP7、多进程、协程、异步任务、mysql连接池、redi连接池、rpc连接池、服务治理、服务注册与发现、Aop切面、全注解 <a href="http://chat.huido.site">http://chat.huido.site</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;net-protocol&quot;&gt;&lt;a href=&quot;#net-protocol&quot; class=&quot;headerlink&quot; title=&quot;@net-protocol&quot;&gt;&lt;/a&gt;@net-protocol&lt;/h2&gt;&lt;p&gt;基于go模拟内核协议栈 实现链路层、网络层、传输层、应用
      
    
    </summary>
    
    
  </entry>
  
</feed>
