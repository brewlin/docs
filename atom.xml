<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Brewlin&#39;s Wiki</title>
  
  <subtitle>found everthing</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.huido.site/"/>
  <updated>2020-01-18T07:52:59.732Z</updated>
  <id>http://blog.huido.site/</id>
  
  <author>
    <name>brewlin</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title></title>
    <link href="http://blog.huido.site/wiki/im-cloud/3.%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/process/process/"/>
    <id>http://blog.huido.site/wiki/im-cloud/3.相关组件/process/process/</id>
    <published>2020-01-18T07:52:59.732Z</published>
    <updated>2020-01-18T07:52:59.732Z</updated>
    
    <summary type="html">
    
    </summary>
    
      <category term="im-cloud" scheme="http://blog.huido.site/categories/im-cloud/"/>
    
      <category term="3.相关组件" scheme="http://blog.huido.site/categories/im-cloud/3-%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/"/>
    
      <category term="process" scheme="http://blog.huido.site/categories/im-cloud/3-%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/process/"/>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://blog.huido.site/wiki/im-cloud/3.%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/task/task/"/>
    <id>http://blog.huido.site/wiki/im-cloud/3.相关组件/task/task/</id>
    <published>2020-01-18T07:52:59.732Z</published>
    <updated>2020-01-18T07:52:59.732Z</updated>
    
    <summary type="html">
    
    </summary>
    
      <category term="im-cloud" scheme="http://blog.huido.site/categories/im-cloud/"/>
    
      <category term="3.相关组件" scheme="http://blog.huido.site/categories/im-cloud/3-%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/"/>
    
      <category term="task" scheme="http://blog.huido.site/categories/im-cloud/3-%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/task/"/>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://blog.huido.site/wiki/im-cloud/3.%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/database/db/"/>
    <id>http://blog.huido.site/wiki/im-cloud/3.相关组件/database/db/</id>
    <published>2020-01-18T07:52:59.732Z</published>
    <updated>2020-01-18T07:52:59.732Z</updated>
    
    <summary type="html">
    
    </summary>
    
      <category term="im-cloud" scheme="http://blog.huido.site/categories/im-cloud/"/>
    
      <category term="3.相关组件" scheme="http://blog.huido.site/categories/im-cloud/3-%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/"/>
    
      <category term="database" scheme="http://blog.huido.site/categories/im-cloud/3-%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/database/"/>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://blog.huido.site/wiki/im-cloud/3.%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/discovery/discovery/"/>
    <id>http://blog.huido.site/wiki/im-cloud/3.相关组件/discovery/discovery/</id>
    <published>2020-01-18T07:52:59.732Z</published>
    <updated>2020-01-18T07:52:59.732Z</updated>
    
    <summary type="html">
    
    </summary>
    
      <category term="im-cloud" scheme="http://blog.huido.site/categories/im-cloud/"/>
    
      <category term="3.相关组件" scheme="http://blog.huido.site/categories/im-cloud/3-%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/"/>
    
      <category term="discovery" scheme="http://blog.huido.site/categories/im-cloud/3-%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/discovery/"/>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://blog.huido.site/wiki/im-cloud/3.%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/grpc/grpc/"/>
    <id>http://blog.huido.site/wiki/im-cloud/3.相关组件/grpc/grpc/</id>
    <published>2020-01-18T07:52:59.732Z</published>
    <updated>2020-01-18T07:52:59.732Z</updated>
    
    <summary type="html">
    
    </summary>
    
      <category term="im-cloud" scheme="http://blog.huido.site/categories/im-cloud/"/>
    
      <category term="3.相关组件" scheme="http://blog.huido.site/categories/im-cloud/3-%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/"/>
    
      <category term="grpc" scheme="http://blog.huido.site/categories/im-cloud/3-%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/grpc/"/>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://blog.huido.site/wiki/im-cloud/3.%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/log/log/"/>
    <id>http://blog.huido.site/wiki/im-cloud/3.相关组件/log/log/</id>
    <published>2020-01-18T07:52:59.732Z</published>
    <updated>2020-01-18T07:52:59.732Z</updated>
    
    <summary type="html">
    
    </summary>
    
      <category term="im-cloud" scheme="http://blog.huido.site/categories/im-cloud/"/>
    
      <category term="3.相关组件" scheme="http://blog.huido.site/categories/im-cloud/3-%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/"/>
    
      <category term="log" scheme="http://blog.huido.site/categories/im-cloud/3-%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/log/"/>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://blog.huido.site/wiki/im-cloud/3.%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/memeory/memeory/"/>
    <id>http://blog.huido.site/wiki/im-cloud/3.相关组件/memeory/memeory/</id>
    <published>2020-01-18T07:52:59.732Z</published>
    <updated>2020-01-18T07:52:59.732Z</updated>
    
    <summary type="html">
    
    </summary>
    
      <category term="im-cloud" scheme="http://blog.huido.site/categories/im-cloud/"/>
    
      <category term="3.相关组件" scheme="http://blog.huido.site/categories/im-cloud/3-%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/"/>
    
      <category term="memeory" scheme="http://blog.huido.site/categories/im-cloud/3-%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/memeory/"/>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://blog.huido.site/wiki/im-cloud/3.%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/redis/redis/"/>
    <id>http://blog.huido.site/wiki/im-cloud/3.相关组件/redis/redis/</id>
    <published>2020-01-18T07:52:59.732Z</published>
    <updated>2020-01-18T07:52:59.732Z</updated>
    
    <summary type="html">
    
    </summary>
    
      <category term="im-cloud" scheme="http://blog.huido.site/categories/im-cloud/"/>
    
      <category term="3.相关组件" scheme="http://blog.huido.site/categories/im-cloud/3-%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/"/>
    
      <category term="redis" scheme="http://blog.huido.site/categories/im-cloud/3-%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/redis/"/>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://blog.huido.site/wiki/im-cloud/3.%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/queue/queue/"/>
    <id>http://blog.huido.site/wiki/im-cloud/3.相关组件/queue/queue/</id>
    <published>2020-01-18T07:52:59.732Z</published>
    <updated>2020-01-18T07:52:59.732Z</updated>
    
    <summary type="html">
    
    </summary>
    
      <category term="im-cloud" scheme="http://blog.huido.site/categories/im-cloud/"/>
    
      <category term="3.相关组件" scheme="http://blog.huido.site/categories/im-cloud/3-%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/"/>
    
      <category term="queue" scheme="http://blog.huido.site/categories/im-cloud/3-%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/queue/"/>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://blog.huido.site/wiki/im-cloud/3.%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/core/core/"/>
    <id>http://blog.huido.site/wiki/im-cloud/3.相关组件/core/core/</id>
    <published>2020-01-18T07:52:59.728Z</published>
    <updated>2020-01-18T07:52:59.728Z</updated>
    
    <summary type="html">
    
    </summary>
    
      <category term="im-cloud" scheme="http://blog.huido.site/categories/im-cloud/"/>
    
      <category term="3.相关组件" scheme="http://blog.huido.site/categories/im-cloud/3-%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/"/>
    
      <category term="core" scheme="http://blog.huido.site/categories/im-cloud/3-%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6/core/"/>
    
    
  </entry>
  
  <entry>
    <title>runtime</title>
    <link href="http://blog.huido.site/wiki/c-ext/hook/runtime/"/>
    <id>http://blog.huido.site/wiki/c-ext/hook/runtime/</id>
    <published>2020-01-13T13:28:59.000Z</published>
    <updated>2020-01-18T07:52:59.728Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Lib-runtime-enableCorutine-启动hook机制"><a href="#Lib-runtime-enableCorutine-启动hook机制" class="headerlink" title="Lib\runtime::enableCorutine 启动hook机制"></a><code>Lib\runtime::enableCorutine</code> 启动hook机制</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Lib\Runtime::enableCoroutine();</span><br><span class="line"></span><br><span class="line">cgo(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">    sleep(<span class="number">1</span>); <span class="comment">// == Cco::sleep(1);</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Lib-runtime-enableCorutine-启动hook机制&quot;&gt;&lt;a href=&quot;#Lib-runtime-enableCorutine-启动hook机制&quot; class=&quot;headerlink&quot; title=&quot;Lib\runtime::enableCor
      
    
    </summary>
    
      <category term="c-ext" scheme="http://blog.huido.site/categories/c-ext/"/>
    
      <category term="hook" scheme="http://blog.huido.site/categories/c-ext/hook/"/>
    
    
      <category term="linux" scheme="http://blog.huido.site/tags/linux/"/>
    
      <category term="c" scheme="http://blog.huido.site/tags/c/"/>
    
      <category term="php" scheme="http://blog.huido.site/tags/php/"/>
    
      <category term="ext" scheme="http://blog.huido.site/tags/ext/"/>
    
      <category term="hook" scheme="http://blog.huido.site/tags/hook/"/>
    
      <category term="runtime" scheme="http://blog.huido.site/tags/runtime/"/>
    
  </entry>
  
  <entry>
    <title>sleep</title>
    <link href="http://blog.huido.site/wiki/c-ext/hook/sleep/"/>
    <id>http://blog.huido.site/wiki/c-ext/hook/sleep/</id>
    <published>2020-01-13T13:28:59.000Z</published>
    <updated>2020-01-18T07:52:59.728Z</updated>
    
    <content type="html"><![CDATA[<p>在扩展内替换原生php内置sleep函数，使原有基于sleep的代码自动进行替换为协程<code>Cco::sleep()</code>调用</p><h2 id="协程sleep"><a href="#协程sleep" class="headerlink" title="@协程sleep"></a>@协程sleep</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cgo(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Cco::sleep(<span class="number">1</span>);<span class="comment">//协程切换</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="原生sleep"><a href="#原生sleep" class="headerlink" title="@原生sleep"></a>@原生sleep</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cgo(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">    sleep(<span class="number">1</span>);<span class="comment">//进程阻塞</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="hook-sleep"><a href="#hook-sleep" class="headerlink" title="@hook sleep"></a>@hook sleep</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Lib\Runtime::enableCoroutine();</span><br><span class="line">cgo(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">    sleep(<span class="number">1</span>);<span class="comment">//协程切换</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在扩展内替换原生php内置sleep函数，使原有基于sleep的代码自动进行替换为协程&lt;code&gt;Cco::sleep()&lt;/code&gt;调用&lt;/p&gt;
&lt;h2 id=&quot;协程sleep&quot;&gt;&lt;a href=&quot;#协程sleep&quot; class=&quot;headerlink&quot; title=
      
    
    </summary>
    
      <category term="c-ext" scheme="http://blog.huido.site/categories/c-ext/"/>
    
      <category term="hook" scheme="http://blog.huido.site/categories/c-ext/hook/"/>
    
    
      <category term="linux" scheme="http://blog.huido.site/tags/linux/"/>
    
      <category term="c" scheme="http://blog.huido.site/tags/c/"/>
    
      <category term="php" scheme="http://blog.huido.site/tags/php/"/>
    
      <category term="ext" scheme="http://blog.huido.site/tags/ext/"/>
    
      <category term="hook" scheme="http://blog.huido.site/tags/hook/"/>
    
      <category term="sleep" scheme="http://blog.huido.site/tags/sleep/"/>
    
  </entry>
  
  <entry>
    <title>event</title>
    <link href="http://blog.huido.site/wiki/c-ext/event/event/"/>
    <id>http://blog.huido.site/wiki/c-ext/event/event/</id>
    <published>2020-01-12T13:28:59.000Z</published>
    <updated>2020-01-18T07:52:59.728Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lib_event_init();</span><br><span class="line"></span><br><span class="line">dosthing...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">lib_event_wait();</span><br></pre></td></tr></table></figure><h2 id="lib-event-init-初始化全局变量和申请内存空间"><a href="#lib-event-init-初始化全局变量和申请内存空间" class="headerlink" title="@lib_event_init() 初始化全局变量和申请内存空间"></a>@lib_event_init() 初始化全局变量和申请内存空间</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LibG;</span><br><span class="line">LibG.poll</span><br><span class="line">LibG.poll.epollfd;</span><br></pre></td></tr></table></figure><h2 id="lib-event-wait-轮训获取可读可写事件"><a href="#lib-event-wait-轮训获取可读可写事件" class="headerlink" title="@lib_event_wait() 轮训获取可读可写事件"></a>@lib_event_wait() 轮训获取可读可写事件</h2><p><code>timer、socket、server、sleep</code>等模块依赖于event，所以需要显示调用event<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">while(LibG.running)&#123;</span><br><span class="line">    epoll_wait(....)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;
      
    
    </summary>
    
      <category term="c-ext" scheme="http://blog.huido.site/categories/c-ext/"/>
    
      <category term="event" scheme="http://blog.huido.site/categories/c-ext/event/"/>
    
    
      <category term="linux" scheme="http://blog.huido.site/tags/linux/"/>
    
      <category term="c" scheme="http://blog.huido.site/tags/c/"/>
    
      <category term="php" scheme="http://blog.huido.site/tags/php/"/>
    
      <category term="ext" scheme="http://blog.huido.site/tags/ext/"/>
    
      <category term="coroutine" scheme="http://blog.huido.site/tags/coroutine/"/>
    
      <category term="epoll" scheme="http://blog.huido.site/tags/epoll/"/>
    
  </entry>
  
  <entry>
    <title>协程socket</title>
    <link href="http://blog.huido.site/wiki/c-ext/coroutine/%E5%8D%8F%E7%A8%8Bsocket/"/>
    <id>http://blog.huido.site/wiki/c-ext/coroutine/协程socket/</id>
    <published>2020-01-12T13:28:59.000Z</published>
    <updated>2020-01-18T07:52:59.728Z</updated>
    
    <content type="html"><![CDATA[<p>创建协程版socket，封装所有协程api，所有阻塞操作都会触发协程切换</p><h2 id="Lib-Coroutine-Socket"><a href="#Lib-Coroutine-Socket" class="headerlink" title="@Lib\Coroutine\Socket"></a>@Lib\Coroutine\Socket</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">lib_event_init();</span><br><span class="line"></span><br><span class="line">cgo(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $socket = <span class="keyword">new</span> Lib\Coroutine\Socket(AF_INET, SOCK_STREAM, IPPROTO_IP);</span><br><span class="line">    <span class="keyword">if</span>($socket-&gt;fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        var_dump(<span class="string">"err"</span>);<span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $socket-&gt;bind(<span class="string">"127.0.0.1"</span>, <span class="number">9999</span>);</span><br><span class="line">    $socket-&gt;listen();</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        $conn = $socket-&gt;accept();</span><br><span class="line">        cgo(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span><span class="params">($conn)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            $data = $conn-&gt;recv();</span><br><span class="line">            $responseStr = <span class="string">"HTTP/1.1 200 OK\r\n</span></span><br><span class="line"><span class="string">                        Content-Type: text/html\r\n</span></span><br><span class="line"><span class="string">                        Connection: close\r\n</span></span><br><span class="line"><span class="string">                        Content-Length: 11\r\n\r\n</span></span><br><span class="line"><span class="string">                        hello world\r\n"</span>;</span><br><span class="line">            $conn-&gt;send($responseStr);</span><br><span class="line">            $conn-&gt;close();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">lib_event_wait();</span><br></pre></td></tr></table></figure><h2 id="Constant"><a href="#Constant" class="headerlink" title="@Constant"></a>@Constant</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AF_INET, SOCK_STREAM, IPPROTO_IP</span><br></pre></td></tr></table></figure><h2 id="construct-初始化"><a href="#construct-初始化" class="headerlink" title="@__construct 初始化"></a>@__construct 初始化</h2><h2 id="bind-绑定端口"><a href="#bind-绑定端口" class="headerlink" title="@bind  绑定端口"></a>@bind  绑定端口</h2><h2 id="listen-启动监听"><a href="#listen-启动监听" class="headerlink" title="@listen 启动监听"></a>@listen 启动监听</h2><h2 id="accept-接收新连接"><a href="#accept-接收新连接" class="headerlink" title="@accept 接收新连接"></a>@accept 接收新连接</h2><h2 id="recv-读取缓冲区数据"><a href="#recv-读取缓冲区数据" class="headerlink" title="@recv   读取缓冲区数据"></a>@recv   读取缓冲区数据</h2><h2 id="send-向对端连接写入数据"><a href="#send-向对端连接写入数据" class="headerlink" title="@send   向对端连接写入数据"></a>@send   向对端连接写入数据</h2><h2 id="close-关闭连接"><a href="#close-关闭连接" class="headerlink" title="@close  关闭连接"></a>@close  关闭连接</h2>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;创建协程版socket，封装所有协程api，所有阻塞操作都会触发协程切换&lt;/p&gt;
&lt;h2 id=&quot;Lib-Coroutine-Socket&quot;&gt;&lt;a href=&quot;#Lib-Coroutine-Socket&quot; class=&quot;headerlink&quot; title=&quot;@Lib\Cor
      
    
    </summary>
    
      <category term="c-ext" scheme="http://blog.huido.site/categories/c-ext/"/>
    
      <category term="coroutine" scheme="http://blog.huido.site/categories/c-ext/coroutine/"/>
    
    
      <category term="linux" scheme="http://blog.huido.site/tags/linux/"/>
    
      <category term="c" scheme="http://blog.huido.site/tags/c/"/>
    
      <category term="php" scheme="http://blog.huido.site/tags/php/"/>
    
      <category term="ext" scheme="http://blog.huido.site/tags/ext/"/>
    
      <category term="coroutine" scheme="http://blog.huido.site/tags/coroutine/"/>
    
      <category term="epoll" scheme="http://blog.huido.site/tags/epoll/"/>
    
      <category term="socket" scheme="http://blog.huido.site/tags/socket/"/>
    
      <category term="tcp" scheme="http://blog.huido.site/tags/tcp/"/>
    
  </entry>
  
  <entry>
    <title>php_引用计数与gc</title>
    <link href="http://blog.huido.site/wiki/blog/php_%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E4%B8%8EGC/"/>
    <id>http://blog.huido.site/wiki/blog/php_引用计数与GC/</id>
    <published>2020-01-10T13:28:59.000Z</published>
    <updated>2020-01-18T07:52:59.728Z</updated>
    
    <content type="html"><![CDATA[<p>进行php扩展开发的时候会遇到一些问题，就是php用户态空间将变量传递到扩展层面<code>c层调用</code>的时候，会出现一些问题，下面的例子是一个timer定时器的例子。<br>用户空间会传递一个回调函数给<code>timer扩展接口</code>，那么实际回调函数被调用的地方是<code>c层</code>。但是该回调函数变量本身是由用户空间<code>申请</code>并交由php<code>内核gc管理</code>的，<br>如果扩展函数内不做任何操作，那么当切换到用户空间时php内核会判断该变量<code>需要回收</code>，然后扩展函数就会空指针异常等</p><p>当扩展函数内该php变量生命周期使用结束后，任然需要考虑<code>垃圾回收</code>的问题，并不是在扩展函数内简单<code>free(data)</code>就可以的，需要调用php内核引用计数接口等<br>进行变量的回收以及gc等，最后交由php内核gc管理。当然扩展函数内由c自行申请管理的内存可以自己释放</p><ul><li><p>扩展函数定义示例</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PHP_METHOD(timer_obj,tick)</span><br><span class="line">&#123;</span><br><span class="line">    php_lib_timer_callback *fci = (php_lib_timer_callback *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(php_lib_timer_callback));</span><br><span class="line">    <span class="comment">//强制传入两个参数</span></span><br><span class="line">    ZEND_PARSE_PARAMETERS_START(<span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">    Z_PARAM_LONG(fci-&gt;seconds)</span><br><span class="line">    Z_PARAM_FUNC(fci-&gt;fci,fci-&gt;fcc)</span><br><span class="line">    ZEND_PARSE_PARAMETERS_END_EX(RETURN_FALSE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> id = create_time_event(fci-&gt;seconds,tick,fci,del);</span><br><span class="line">    zend_fci_cache_persist(&amp;fci-&gt;fcc);</span><br><span class="line">    RETURN_LONG(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>扩展函数内执行php用户态回调函数示例</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tick</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> id,<span class="keyword">void</span> *data)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    php_lib_timer_callback *fci = (php_lib_timer_callback *)data;</span><br><span class="line">    zval result;</span><br><span class="line">    fci-&gt;fci.retval = &amp;result;</span><br><span class="line">    <span class="keyword">if</span>(zend_call_function(&amp;fci-&gt;fci,&amp;fci-&gt;fcc) != SUCCESS)&#123;</span><br><span class="line">        <span class="keyword">return</span> NOMORE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fci-&gt;seconds;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="timer-中对回调函数变量进行引用计数-1"><a href="#timer-中对回调函数变量进行引用计数-1" class="headerlink" title="timer 中对回调函数变量进行引用计数+1"></a>timer 中对回调函数变量进行引用计数+1</h2><p>上面会发现timer::tick()函数在返回给用户空间时会做一个操作<code>zend_fci_cache_persist(&amp;fci-&gt;fcc);</code>，正是该调用<br>对传入的回调函数进行饮用计数管理，<code>告诉php内核该回调函数在c层会继续使用不用回收</code>。代码如下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">zend_fci_cache_persist</span><span class="params">(zend_fcall_info_cache *fci_cache)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (fci_cache-&gt;object)</span><br><span class="line">    &#123;</span><br><span class="line">        GC_ADDREF(fci_cache-&gt;object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fci_cache-&gt;function_handler-&gt;op_array.fn_flags &amp; ZEND_ACC_CLOSURE)</span><br><span class="line">    &#123;</span><br><span class="line">        GC_ADDREF(ZEND_CLOSURE_OBJECT(fci_cache-&gt;function_handler));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>其中<code>GC_ADDREF（）</code>函数很明显就是内核GC相关的api。<code>fci_cache-&gt;function_handler</code> 则为用户传递的回调函数真正的变量地址</p><p>如上前奏后就可以在c扩展中放心的对用户传递的变量进行操作了</p><h2 id="timer-中结束后变量的Gc回收"><a href="#timer-中结束后变量的Gc回收" class="headerlink" title="timer 中结束后变量的Gc回收"></a>timer 中结束后变量的Gc回收</h2><p>上面有看到<code>php_lib_timer_callback</code>变量实际是自己定义的结构体，包括内存也是有开发者自己分配的，可以放心的<code>free</code>。但是该结构体中<br>指向的<code>fci.fcc</code> 则实际是php用户空间申请的变量，不能直接<code>free</code>,如果直接free，会引发php gc泄漏，如下警告所示:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; php timer.php</span><br><span class="line">/php/src/Zend/zend_closures.c(<span class="number">459</span>) :  Freeing <span class="number">0x00007fc084e6d480</span> (<span class="number">304</span> bytes), script=/timer.php</span><br><span class="line">=== Total <span class="number">1</span> memory leaks detected ===</span><br></pre></td></tr></table></figure></p><p>所以依然需要根据php内核GC的管理方式来处理用户空间的变量，也就是模拟用户空间那样对变量的管理：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">zend_fci_cache_discard</span><span class="params">(zend_fcall_info_cache *fci_cache)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (fci_cache-&gt;object) &#123;</span><br><span class="line">        OBJ_RELEASE(fci_cache-&gt;object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fci_cache-&gt;function_handler-&gt;op_array.fn_flags &amp; ZEND_ACC_CLOSURE) &#123;</span><br><span class="line">        OBJ_RELEASE(ZEND_CLOSURE_OBJECT(fci_cache-&gt;function_handler));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">zend_fci_params_discard</span><span class="params">(zend_fcall_info *fci)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (fci-&gt;param_count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> i;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; fci-&gt;param_count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            zval_ptr_dtor(&amp;fci-&gt;params[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        efree(fci-&gt;params);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>在不需要使用的时候，也需要对回调函数本身进行减引用，以及回调函数内的用户态的参数进行减引用以及变量的回收。只有做完上面这些基本的管理才能<br>开发一个安全的扩展函数</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总之用户空间申请的变量传递给扩展内函数使用，如果在返回给用户空间后依然会继续使用就要zval_copy或者引用计数+1,因为在返回给用户空间的时候本身用户空间gc会判断该变量是否有继续引用，否则就<code>refcount -= 1</code>，用户空间回收该变量，但是扩展函数内依然在访问该已经被销毁的变量。就会导致错误</p><p>只有将这些变量的引用与回收做好了才能开发出安全可靠的扩展函数</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;进行php扩展开发的时候会遇到一些问题，就是php用户态空间将变量传递到扩展层面&lt;code&gt;c层调用&lt;/code&gt;的时候，会出现一些问题，下面的例子是一个timer定时器的例子。&lt;br&gt;用户空间会传递一个回调函数给&lt;code&gt;timer扩展接口&lt;/code&gt;，那么实际回调函
      
    
    </summary>
    
      <category term="blog" scheme="http://blog.huido.site/categories/blog/"/>
    
    
      <category term="linux" scheme="http://blog.huido.site/tags/linux/"/>
    
      <category term="c" scheme="http://blog.huido.site/tags/c/"/>
    
      <category term="php" scheme="http://blog.huido.site/tags/php/"/>
    
      <category term="ext" scheme="http://blog.huido.site/tags/ext/"/>
    
      <category term="refrerence" scheme="http://blog.huido.site/tags/refrerence/"/>
    
      <category term="gc" scheme="http://blog.huido.site/tags/gc/"/>
    
  </entry>
  
  <entry>
    <title>tap</title>
    <link href="http://blog.huido.site/wiki/net-protocol/6.%E7%89%A9%E7%90%86%E5%B1%82/tap/"/>
    <id>http://blog.huido.site/wiki/net-protocol/6.物理层/tap/</id>
    <published>2020-01-10T13:28:59.000Z</published>
    <updated>2020-01-18T07:52:59.732Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-创建一个tap模式的虚拟网卡tap0"><a href="#1-创建一个tap模式的虚拟网卡tap0" class="headerlink" title="1.创建一个tap模式的虚拟网卡tap0"></a>1.创建一个tap模式的虚拟网卡tap0</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ip tuntap add mode tap tap0</span><br></pre></td></tr></table></figure><h3 id="2-开启该网卡"><a href="#2-开启该网卡" class="headerlink" title="2.开启该网卡"></a>2.开启该网卡</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ip link set tap0 up</span><br></pre></td></tr></table></figure><h3 id="3-设置该网卡的ip及掩码-添加路由"><a href="#3-设置该网卡的ip及掩码-添加路由" class="headerlink" title="3.设置该网卡的ip及掩码 |添加路由"></a>3.设置该网卡的ip及掩码 |添加路由</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo ip route add 192.168.1.0/24 dev tap0</span><br><span class="line">//增加ip地址</span><br><span class="line">sudo ip addr add 192.168.1.1/24 dev tap0</span><br></pre></td></tr></table></figure><h3 id="4-添加网关"><a href="#4-添加网关" class="headerlink" title="4.添加网关"></a>4.添加网关</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ip route add default via 192.168.1.2 dev tap0</span><br></pre></td></tr></table></figure><h2 id="删除网卡"><a href="#删除网卡" class="headerlink" title="@删除网卡"></a>@删除网卡</h2><h3 id="1-删除虚拟网卡"><a href="#1-删除虚拟网卡" class="headerlink" title="1.删除虚拟网卡"></a>1.删除虚拟网卡</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ip tuntap del mode tap tap0</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;1-创建一个tap模式的虚拟网卡tap0&quot;&gt;&lt;a href=&quot;#1-创建一个tap模式的虚拟网卡tap0&quot; class=&quot;headerlink&quot; title=&quot;1.创建一个tap模式的虚拟网卡tap0&quot;&gt;&lt;/a&gt;1.创建一个tap模式的虚拟网卡tap0&lt;/h3&gt;&lt;
      
    
    </summary>
    
      <category term="net-protocol" scheme="http://blog.huido.site/categories/net-protocol/"/>
    
      <category term="6.物理层" scheme="http://blog.huido.site/categories/net-protocol/6-%E7%89%A9%E7%90%86%E5%B1%82/"/>
    
    
      <category term="go" scheme="http://blog.huido.site/tags/go/"/>
    
      <category term="protocol" scheme="http://blog.huido.site/tags/protocol/"/>
    
      <category term="eth" scheme="http://blog.huido.site/tags/eth/"/>
    
      <category term="tap" scheme="http://blog.huido.site/tags/tap/"/>
    
      <category term="tool" scheme="http://blog.huido.site/tags/tool/"/>
    
  </entry>
  
  <entry>
    <title>定时器</title>
    <link href="http://blog.huido.site/wiki/c-ext/timer/%E5%AE%9A%E6%97%B6%E5%99%A8/"/>
    <id>http://blog.huido.site/wiki/c-ext/timer/定时器/</id>
    <published>2020-01-10T13:28:59.000Z</published>
    <updated>2020-01-18T07:52:59.728Z</updated>
    
    <content type="html"><![CDATA[<h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">lib_event_init();</span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器 毫秒单位 循环触发</span></span><br><span class="line">$timerid = Lib\Timer::tick(<span class="number">1000</span>,<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"定时器循环"</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器 毫秒单位 触发单次</span></span><br><span class="line">Lib\Timer::after(<span class="number">1000</span>,<span class="function"><span class="keyword">function</span><span class="params">()</span><span class="title">use</span><span class="params">($timerid)</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"只执行一次"</span>;</span><br><span class="line">    <span class="comment">//定时器 毫秒单位 触发单次</span></span><br><span class="line">    Lib\Timer::after(<span class="number">2000</span>,<span class="function"><span class="keyword">function</span><span class="params">()</span><span class="title">use</span><span class="params">($timerid)</span></span>&#123;</span><br><span class="line">        <span class="comment">//定时器删除</span></span><br><span class="line">        Lib\Timer::del($timerid);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">lib_event_wait();</span><br></pre></td></tr></table></figure><h2 id="tick-无限触发定时任务"><a href="#tick-无限触发定时任务" class="headerlink" title="@tick 无限触发定时任务"></a>@tick 无限触发定时任务</h2><p><code>long Lib\Timer::tick(long long seconds,$callback);</code><br>单位为毫秒</p><p>底层基于epoll_wait 阻塞触发定时</p><h2 id="after-单次任务执行"><a href="#after-单次任务执行" class="headerlink" title="@after 单次任务执行"></a>@after 单次任务执行</h2><p><code>long  Lib\Timer::after(long long seconds,$callback);</code></p><h2 id="del-删除定时任务"><a href="#del-删除定时任务" class="headerlink" title="@del 删除定时任务"></a>@del 删除定时任务</h2><p><code>long Lib\Timer::del(long timerid);</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;demo&quot;&gt;&lt;a href=&quot;#demo&quot; class=&quot;headerlink&quot; title=&quot;demo&quot;&gt;&lt;/a&gt;demo&lt;/h2&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;
      
    
    </summary>
    
      <category term="c-ext" scheme="http://blog.huido.site/categories/c-ext/"/>
    
      <category term="timer" scheme="http://blog.huido.site/categories/c-ext/timer/"/>
    
    
      <category term="linux" scheme="http://blog.huido.site/tags/linux/"/>
    
      <category term="c" scheme="http://blog.huido.site/tags/c/"/>
    
      <category term="php" scheme="http://blog.huido.site/tags/php/"/>
    
      <category term="ext" scheme="http://blog.huido.site/tags/ext/"/>
    
      <category term="epoll" scheme="http://blog.huido.site/tags/epoll/"/>
    
      <category term="timer" scheme="http://blog.huido.site/tags/timer/"/>
    
  </entry>
  
  <entry>
    <title>协程tcp服务</title>
    <link href="http://blog.huido.site/wiki/c-ext/coroutine/%E5%8D%8F%E7%A8%8Btcp%E6%9C%8D%E5%8A%A1/"/>
    <id>http://blog.huido.site/wiki/c-ext/coroutine/协程tcp服务/</id>
    <published>2020-01-05T13:28:59.000Z</published>
    <updated>2020-01-18T07:52:59.728Z</updated>
    
    <content type="html"><![CDATA[<p>创建协程版server，封装所有协程api，所有阻塞操作都会触发协程切换</p><h2 id="Lib-Coroutine-Server"><a href="#Lib-Coroutine-Server" class="headerlink" title="@Lib\Coroutine\Server"></a>@Lib\Coroutine\Server</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化全局对象 epoll等内存空间初始化</span></span><br><span class="line">lib_event_init();</span><br><span class="line"></span><br><span class="line"><span class="comment">//协程运行</span></span><br><span class="line">cgo(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        $server = <span class="keyword">new</span> Lib\Coroutine\Server(<span class="string">"127.0.0.1"</span>, <span class="number">9991</span>);</span><br><span class="line">        $server-&gt;set_handler(<span class="function"><span class="keyword">function</span> <span class="params">(Lib\Coroutine\Socket $conn)</span> <span class="title">use</span><span class="params">($server)</span> </span>&#123;</span><br><span class="line">                $data = $conn-&gt;recv();</span><br><span class="line">                $responseStr = <span class="string">"HTTP/1.1 200 OK\r\n</span></span><br><span class="line"><span class="string">                                Content-Type: text/html\r\n</span></span><br><span class="line"><span class="string">                                Connection: close\r\n</span></span><br><span class="line"><span class="string">                                Content-Length: 11\r\n\r\n</span></span><br><span class="line"><span class="string">                                hello world\r\n"</span>;</span><br><span class="line">                $conn-&gt;send($responseStr);</span><br><span class="line">                $conn-&gt;close();</span><br><span class="line">                <span class="comment">// Sco::sleep(0.01);</span></span><br><span class="line">        &#125;);</span><br><span class="line">        $server-&gt;start();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//epoll event 轮循 检查事件</span></span><br><span class="line">lib_event_wait();</span><br></pre></td></tr></table></figure><h2 id="construct-初始化"><a href="#construct-初始化" class="headerlink" title="@__construct 初始化"></a>@__construct 初始化</h2><h2 id="set-handler-callback-回调触发事件"><a href="#set-handler-callback-回调触发事件" class="headerlink" title="@set_handler($callback)  回调触发事件"></a>@set_handler($callback)  回调触发事件</h2><h2 id="start-启动监听"><a href="#start-启动监听" class="headerlink" title="start() 启动监听"></a>start() 启动监听</h2>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;创建协程版server，封装所有协程api，所有阻塞操作都会触发协程切换&lt;/p&gt;
&lt;h2 id=&quot;Lib-Coroutine-Server&quot;&gt;&lt;a href=&quot;#Lib-Coroutine-Server&quot; class=&quot;headerlink&quot; title=&quot;@Lib\Cor
      
    
    </summary>
    
      <category term="c-ext" scheme="http://blog.huido.site/categories/c-ext/"/>
    
      <category term="coroutine" scheme="http://blog.huido.site/categories/c-ext/coroutine/"/>
    
    
      <category term="linux" scheme="http://blog.huido.site/tags/linux/"/>
    
      <category term="c" scheme="http://blog.huido.site/tags/c/"/>
    
      <category term="php" scheme="http://blog.huido.site/tags/php/"/>
    
      <category term="ext" scheme="http://blog.huido.site/tags/ext/"/>
    
      <category term="coroutine" scheme="http://blog.huido.site/tags/coroutine/"/>
    
      <category term="epoll" scheme="http://blog.huido.site/tags/epoll/"/>
    
      <category term="socket" scheme="http://blog.huido.site/tags/socket/"/>
    
      <category term="tcp" scheme="http://blog.huido.site/tags/tcp/"/>
    
  </entry>
  
  <entry>
    <title>协程</title>
    <link href="http://blog.huido.site/wiki/c-ext/coroutine/%E5%8D%8F%E7%A8%8B/"/>
    <id>http://blog.huido.site/wiki/c-ext/coroutine/协程/</id>
    <published>2020-01-05T13:28:59.000Z</published>
    <updated>2020-01-18T07:52:59.728Z</updated>
    
    <content type="html"><![CDATA[<p>将协程任务保存到扩展事件中进行调度</p><h2 id="cgo"><a href="#cgo" class="headerlink" title="@cgo"></a>@cgo</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化全局对象 epoll等内存空间初始化</span></span><br><span class="line">lib_event_init();</span><br><span class="line"></span><br><span class="line"><span class="comment">//协程运行</span></span><br><span class="line">cgo(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"go"</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//epoll event 轮循 检查事件</span></span><br><span class="line">lib_event_wait();</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;将协程任务保存到扩展事件中进行调度&lt;/p&gt;
&lt;h2 id=&quot;cgo&quot;&gt;&lt;a href=&quot;#cgo&quot; class=&quot;headerlink&quot; title=&quot;@cgo&quot;&gt;&lt;/a&gt;@cgo&lt;/h2&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;
      
    
    </summary>
    
      <category term="c-ext" scheme="http://blog.huido.site/categories/c-ext/"/>
    
      <category term="coroutine" scheme="http://blog.huido.site/categories/c-ext/coroutine/"/>
    
    
      <category term="linux" scheme="http://blog.huido.site/tags/linux/"/>
    
      <category term="c" scheme="http://blog.huido.site/tags/c/"/>
    
      <category term="php" scheme="http://blog.huido.site/tags/php/"/>
    
      <category term="ext" scheme="http://blog.huido.site/tags/ext/"/>
    
      <category term="coroutine" scheme="http://blog.huido.site/tags/coroutine/"/>
    
      <category term="epoll" scheme="http://blog.huido.site/tags/epoll/"/>
    
  </entry>
  
  <entry>
    <title>进程管理</title>
    <link href="http://blog.huido.site/wiki/c-ext/process/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/"/>
    <id>http://blog.huido.site/wiki/c-ext/process/进程管理/</id>
    <published>2019-12-20T13:28:59.000Z</published>
    <updated>2020-01-18T07:52:59.728Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Lib-Process"><a href="#Lib-Process" class="headerlink" title="@Lib/Process"></a>@<code>Lib/Process</code></h2><p>该扩展初始化传入回调函数并创建子进程执行，子进程间可以通过channel通讯<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$process = <span class="keyword">new</span> Lib\Process(<span class="function"><span class="keyword">function</span><span class="params">(Lib\Process $process)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">        $data = $process-&gt;read();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"child process :&gt; get parent msg: $data \n\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$process-&gt;start();</span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>;$i &lt; <span class="number">10</span> ; $i ++ )&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"parent process :&gt; send child msg: $i\n"</span>;</span><br><span class="line">    $process-&gt;write($i);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="construct"><a href="#construct" class="headerlink" title="@construct()"></a>@<code>construct()</code></h2><p>初始化构造函数时必须传入回调函数，在子进程创建时会调用</p><h2 id="start"><a href="#start" class="headerlink" title="@start()"></a>@<code>start()</code></h2><p>执行创建子进程操作</p><h2 id="process-gt-write-data"><a href="#process-gt-write-data" class="headerlink" title="@$process-&gt;write($data)"></a>@<code>$process-&gt;write($data)</code></h2><p>向子进程或者父进程写入数据</p><h2 id="process-gt-read"><a href="#process-gt-read" class="headerlink" title="@$process-&gt;read()"></a>@<code>$process-&gt;read()</code></h2><p>向子进程或父进程读取数据</p><h2 id="process-gt-getpid"><a href="#process-gt-getpid" class="headerlink" title="@$process-&gt;getpid()"></a>@<code>$process-&gt;getpid()</code></h2><p>获取当前进程id</p><h2 id="process-gt-getppid"><a href="#process-gt-getppid" class="headerlink" title="@$process-&gt;getppid()"></a>@<code>$process-&gt;getppid()</code></h2><p>获取父进程id</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Lib-Process&quot;&gt;&lt;a href=&quot;#Lib-Process&quot; class=&quot;headerlink&quot; title=&quot;@Lib/Process&quot;&gt;&lt;/a&gt;@&lt;code&gt;Lib/Process&lt;/code&gt;&lt;/h2&gt;&lt;p&gt;该扩展初始化传入回调函数并创建子进程执
      
    
    </summary>
    
      <category term="c-ext" scheme="http://blog.huido.site/categories/c-ext/"/>
    
      <category term="process" scheme="http://blog.huido.site/categories/c-ext/process/"/>
    
    
      <category term="linux" scheme="http://blog.huido.site/tags/linux/"/>
    
      <category term="c" scheme="http://blog.huido.site/tags/c/"/>
    
      <category term="php" scheme="http://blog.huido.site/tags/php/"/>
    
      <category term="ext" scheme="http://blog.huido.site/tags/ext/"/>
    
      <category term="syscall" scheme="http://blog.huido.site/tags/syscall/"/>
    
      <category term="process" scheme="http://blog.huido.site/tags/process/"/>
    
      <category term="channel" scheme="http://blog.huido.site/tags/channel/"/>
    
  </entry>
  
</feed>
