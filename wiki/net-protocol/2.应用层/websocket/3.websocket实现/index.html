<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>websocket实现 | Brewlin&#39;s Wiki</title><meta name="keywords" content="protocol,golang,websocket"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="编写基本的httpserver启动一个基本的httpserver，提供两个接口，一个index返回主页，另一个是就是我们自定义的websocket协议接口@main.go123456789101112131415161718192021222324252627282930313233343536373839404142434445464748package mainimport (	&quot;fmt&quot;	&quot;"><meta name="keywords" content="protocol,golang,websocket"><meta property="og:type" content="article"><meta property="og:title" content="websocket实现"><meta property="og:url" content="http://blog.huido.site/wiki/net-protocol/2.应用层/websocket/3.websocket实现/index.html"><meta property="og:site_name" content="Brewlin&#39;s Wiki"><meta property="og:description" content="编写基本的httpserver启动一个基本的httpserver，提供两个接口，一个index返回主页，另一个是就是我们自定义的websocket协议接口@main.go123456789101112131415161718192021222324252627282930313233343536373839404142434445464748package mainimport (	&quot;fmt&quot;	&quot;"><meta property="og:locale" content="en"><meta property="og:image" content="http://blog.huido.site/images/websocket.png"><meta property="og:updated_time" content="2019-10-31T14:15:51.121Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="websocket实现"><meta name="twitter:description" content="编写基本的httpserver启动一个基本的httpserver，提供两个接口，一个index返回主页，另一个是就是我们自定义的websocket协议接口@main.go123456789101112131415161718192021222324252627282930313233343536373839404142434445464748package mainimport (	&quot;fmt&quot;	&quot;"><meta name="twitter:image" content="http://blog.huido.site/images/websocket.png"><link rel="alternate" href="/atom.xml" title="Brewlin&#39;s Wiki" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="/libs/open-sans/styles.css"><link rel="stylesheet" href="/libs/source-code-pro/styles.css"><link rel="stylesheet" href="/css/style.css"><script src="/libs/jquery/2.1.3/jquery.min.js"></script><script src="/libs/jquery/plugins/cookie/1.4.1/jquery.cookie.js"></script><link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css"><link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><div id="container"><header id="header"><div id="header-main" class="header-inner"><div class="outer"><a href="/" id="logo"><i class="logo"></i> <span class="site-title">Brewlin&#39;s Wiki</span></a><nav id="main-nav"> <a class="main-nav-link" href="/">首页</a> <a class="main-nav-link" href="/archives">归档</a> <a class="main-nav-link" href="/categories">分类</a> <a class="main-nav-link" href="/tags">标签</a> <a class="main-nav-link" href="/about">关于</a></nav><div id="search-form-wrap"><form class="search-form"> <input type="text" class="ins-search-input search-form-input" placeholder="Search"> <button type="submit" class="search-form-submit"></button></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"> <input type="text" class="ins-search-input" placeholder="Type something..."><span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script></div></div></div><div id="main-nav-mobile" class="header-sub header-inner"><table class="menu outer"><tr><td><a class="main-nav-link" href="/">首页</a></td><td><a class="main-nav-link" href="/archives">归档</a></td><td><a class="main-nav-link" href="/categories">分类</a></td><td><a class="main-nav-link" href="/tags">标签</a></td><td><a class="main-nav-link" href="/about">关于</a></td><td><div class="search-form"> <input type="text" class="ins-search-input search-form-input" placeholder="Search"></div></td></tr></table></div></header><div class="outer"><aside id="sidebar"><div class="widget-wrap" id="categories"><h3 class="widget-title"> <span>categories</span> &nbsp;<a id="allExpand" href="#"><i class="fa fa-angle-double-down fa-2x"></i></a></h3><ul class="unstyled" id="tree"><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; go-stl</a><ul class="unstyled" id="tree"><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; graph</a><ul class="unstyled" id="tree"><li class="file"><a href="/wiki/go-stl/graph/图论/">图论算法</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; raft</a><ul class="unstyled" id="tree"><li class="file"><a href="/wiki/go-stl/raft/raft分布式一致性原理(一)/">raft分布式一致性原理(一)</a></li><li class="file"><a href="/wiki/go-stl/raft/raft分布式一致性原理(二)/">raft分布式一致性原理(二)</a></li><li class="file"><a href="/wiki/go-stl/raft/相关资料/">相关资料</a></li></ul></li><li class="file"><a href="/wiki/go-stl/index/">GO标准库和算法应用</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; im-cloud</a><ul class="unstyled" id="tree"><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; 1.前言</a><ul class="unstyled" id="tree"><li class="file"><a href="/wiki/im-cloud/1.前言/1.安装部署/">安装部署</a></li><li class="file"><a href="/wiki/im-cloud/1.前言/2.并发压测对比/">并发压测对比</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; 2.底层实现</a><ul class="unstyled" id="tree"><li class="file"><a href="/wiki/im-cloud/2.底层实现/1.im-cloud/">im-cloud</a></li><li class="file"><a href="/wiki/im-cloud/2.底层实现/2.通讯协议/">通讯协议</a></li><li class="file"><a href="/wiki/im-cloud/2.底层实现/4.job节点/">job节点实现</a></li><li class="file"><a href="/wiki/im-cloud/2.底层实现/5.logic节点/">logic节点实现</a></li><li class="file"><a href="/wiki/im-cloud/2.底层实现/3.cloud节点/">cloud节点实现</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; 3.应用实现</a><ul class="unstyled" id="tree"><li class="file"><a href="/wiki/im-cloud/3.应用实现/1.推送实现/">推送实现</a></li><li class="file"><a href="/wiki/im-cloud/3.应用实现/2.服务发现/">服务发现</a></li></ul></li><li class="file"><a href="/wiki/im-cloud/index/">im-cloud 分布式推送中间件</a></li></ul></li><li class="directory open"><a href="#" data-role="directory"><i class="fa fa-folder-open"></i> &nbsp; net-protocol</a><ul class="unstyled" id="tree"><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; 1.前言</a><ul class="unstyled" id="tree"><li class="file"><a href="/wiki/net-protocol/1.前言/1.快速开始/">快速开始</a></li></ul></li><li class="directory open"><a href="#" data-role="directory"><i class="fa fa-folder-open"></i> &nbsp; 2.应用层</a><ul class="unstyled" id="tree"><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; http</a><ul class="unstyled" id="tree"><li class="file"><a href="/wiki/net-protocol/2.应用层/http/1.http协议解析/">http协议解析</a></li></ul></li><li class="directory open"><a href="#" data-role="directory"><i class="fa fa-folder-open"></i> &nbsp; websocket</a><ul class="unstyled" id="tree"><li class="file"><a href="/wiki/net-protocol/2.应用层/websocket/2.websocket算法/">websocket算法</a></li><li class="file"><a href="/wiki/net-protocol/2.应用层/websocket/1.websocket协议解析/">websocket协议解析</a></li><li class="file active"><a href="/wiki/net-protocol/2.应用层/websocket/3.websocket实现/">websocket实现</a></li></ul></li><li class="file"><a href="/wiki/net-protocol/2.应用层/应用层前世今生/">应用层前世今生</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; 3.传输层</a><ul class="unstyled" id="tree"><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; tcp</a><ul class="unstyled" id="tree"><li class="file"><a href="/wiki/net-protocol/3.传输层/tcp/2.流量控制/">tcp流量控制</a></li><li class="file"><a href="/wiki/net-protocol/3.传输层/tcp/3.可靠性机制/">tcp可靠性机制</a></li><li class="file"><a href="/wiki/net-protocol/3.传输层/tcp/1.头部/">tcp头部</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; udp</a><ul class="unstyled" id="tree"><li class="file"><a href="/wiki/net-protocol/3.传输层/udp/1.协议/">udp协议</a></li></ul></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; 4.网络层</a><ul class="unstyled" id="tree"><li class="file"><a href="/wiki/net-protocol/4.网络层/arp协议/">arp协议</a></li><li class="file"><a href="/wiki/net-protocol/4.网络层/协议_icmp/">icmp协议</a></li><li class="file"><a href="/wiki/net-protocol/4.网络层/协议_端口/">端口机制</a></li><li class="file"><a href="/wiki/net-protocol/4.网络层/协议_ip/">ip协议</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; 5.链路层</a><ul class="unstyled" id="tree"><li class="file"><a href="/wiki/net-protocol/5.链路层/1.以太网协议/">以太网协议</a></li></ul></li><li class="file"><a href="/wiki/net-protocol/index/">index</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; swoft-im</a><ul class="unstyled" id="tree"><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; 前言</a><ul class="unstyled" id="tree"><li class="file"><a href="/wiki/swoft-im/前言/业务说明/">业务说明</a></li></ul></li><li class="file"><a href="/wiki/swoft-im/index/">微服务应用</a></li></ul></li><li class="file"><a href="/wiki/index/">Welcome Brewlin's Wiki Site</a></li></ul></div><script>$(document).ready(function(){var r="fa-folder-open",i="fa-folder",l="fa-angle-double-down",d="fa-angle-double-up";$(document).on("click",'#categories a[data-role="directory"]',function(a){a.preventDefault();var e=$(this).children(".fa"),s=e.hasClass(r),l=$(this).siblings("ul");e.removeClass(r).removeClass(i),s?(void 0!==l&&l.slideUp({duration:100}),e.addClass(i)):(void 0!==l&&l.slideDown({duration:100}),e.addClass(r))}),$('#categories a[data-role="directory"]').bind("contextmenu",function(a){a.preventDefault();var e=$(this).children(".fa"),s=e.hasClass(r),l=$(this).siblings("ul"),d=$.merge(l.find("li ul"),l),o=$.merge(l.find(".fa"),e);o.removeClass(r).removeClass(i),s?(d.slideUp({duration:100}),o.addClass(i)):(d.slideDown({duration:100}),o.addClass(r))}),$(document).on("click","#allExpand",function(a){a.preventDefault();var e=$(this).children(".fa"),s=e.hasClass(l);e.removeClass(l).removeClass(d),s?($("#sidebar .fa.fa-folder").removeClass("fa-folder").addClass("fa-folder-open"),$("#categories li ul").slideDown({duration:100}),e.addClass(d)):($("#sidebar .fa.fa-folder-open").removeClass("fa-folder-open").addClass("fa-folder"),$("#categories li ul").slideUp({duration:100}),e.addClass(l))})})</script><div id="toTop" class="fa fa-angle-up"></div></aside><section id="main"><article id="post-net-protocol/2.应用层/websocket/3.websocket实现" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><div class="article-meta"><div class="article-category"><i class="fa fa-folder"></i> <a class="article-category-link" href="/categories/net-protocol/">net-protocol</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/net-protocol/2-应用层/">2.应用层</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/net-protocol/2-应用层/websocket/">websocket</a></div><div class="article-tag"><i class="fa fa-tag"></i> <a class="tag-link" href="/tags/golang/">golang</a>, <a class="tag-link" href="/tags/protocol/">protocol</a>, <a class="tag-link" href="/tags/websocket/">websocket</a></div><div class="article-date"><i class="fa fa-calendar"></i> <a href="/wiki/net-protocol/2.应用层/websocket/3.websocket实现/"><time datetime="2019-10-21T13:28:59.000Z" itemprop="datePublished">2019-10-21</time></a></div><i class="fa fa-bar-chart"></i><span id="busuanzi_container_site_pv"><span id="busuanzi_value_page_pv"></span></span><div class="article-meta-button"> <a href="https://github.com/brewlin/docs/raw/master/source/_posts/net-protocol/2.应用层/websocket/3.websocket实现.md">Source</a></div><div class="article-meta-button"> <a href="https://github.com/brewlin/docs/edit/master/source/_posts/net-protocol/2.应用层/websocket/3.websocket实现.md">Edit</a></div><div class="article-meta-button"> <a href="https://github.com/brewlin/docs/commits/master/source/_posts/net-protocol/2.应用层/websocket/3.websocket实现.md">History</a></div></div><h1 class="article-title" itemprop="name"> websocket实现</h1></header><div class="article-entry" itemprop="articleBody"><h2 id="编写基本的httpserver"><a href="#编写基本的httpserver" class="headerlink" title="编写基本的httpserver"></a>编写基本的httpserver</h2><h3 id="启动一个基本的httpserver，提供两个接口，一个index返回主页，另一个是就是我们自定义的websocket协议接口"><a href="#启动一个基本的httpserver，提供两个接口，一个index返回主页，另一个是就是我们自定义的websocket协议接口" class="headerlink" title="启动一个基本的httpserver，提供两个接口，一个index返回主页，另一个是就是我们自定义的websocket协议接口"></a>启动一个基本的httpserver，提供两个接口，一个<code>index</code>返回主页，另一个是就是我们自定义的<code>websocket</code>协议接口</h3><h3 id="main-go"><a href="#main-go" class="headerlink" title="@main.go"></a>@main.go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"github.com/brewlin/net-protocol/pkg/logging"</span></span><br><span class="line">	<span class="string">"github.com/brewlin/net-protocol/protocol/application/http"</span></span><br><span class="line">	<span class="string">"github.com/brewlin/net-protocol/protocol/application/websocket"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	logging.Setup()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	serv := http.NewHTTP(<span class="string">"tap1"</span>, <span class="string">"192.168.1.0/24"</span>, <span class="string">"192.168.1.1"</span>, <span class="string">"9502"</span>)</span><br><span class="line">	serv.HandleFunc(<span class="string">"/ws"</span>, echo)</span><br><span class="line"></span><br><span class="line">	serv.HandleFunc(<span class="string">"/"</span>, <span class="function"><span class="keyword">func</span><span class="params">(request *http.Request, response *http.Response)</span></span> &#123;</span><br><span class="line">		response.End(<span class="string">"hello"</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	fmt.Println(<span class="string">"@main: server is start ip:192.168.1.1 port:9502 "</span>)</span><br><span class="line">	serv.ListenAndServ()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//websocket处理器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">echo</span><span class="params">(r *http.Request, w *http.Response)</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">"got http request ; start to  upgrade websocket protocol...."</span>)</span><br><span class="line">	<span class="comment">//协议升级 c *websocket.Conn</span></span><br><span class="line">	c, err := websocket.Upgrade(r, w)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">//升级协议失败，直接return 交由http处理响应</span></span><br><span class="line">		fmt.Println(<span class="string">"Upgrade error:"</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> c.Close()</span><br><span class="line">	<span class="comment">//循环处理数据，接受数据，然后返回</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		message, err := c.ReadData()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(<span class="string">"read:"</span>, err)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Println(<span class="string">"recv client msg:"</span>, <span class="keyword">string</span>(message))</span><br><span class="line">		<span class="comment">// c.SendData(message )</span></span><br><span class="line">		c.SendData([]<span class="keyword">byte</span>(<span class="string">"hello"</span>))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="echo-接口接受http请求并进行升级我们的websocket"><a href="#echo-接口接受http请求并进行升级我们的websocket" class="headerlink" title="echo 接口接受http请求并进行升级我们的websocket"></a>echo 接口接受http请求并进行升级我们的websocket</h3><h3 id="页面如下"><a href="#页面如下" class="headerlink" title="页面如下"></a>页面如下</h3><p><img src="/images/websocket.png" alt="index"></p><h2 id="自定义的webscoket-upgrade进行升级"><a href="#自定义的webscoket-upgrade进行升级" class="headerlink" title="自定义的webscoket upgrade进行升级"></a>自定义的webscoket upgrade进行升级</h2><h3 id="根据之前的协议分析，我知道握手的过程其实就是检查-HTTP-请求头部字段的过程，值得注意的一点就是需要针对客户端发送的-Sec-WebSocket-Key-生成一个正确的-Sec-WebSocket-Accept-只。关于生成的-Sec-WebSocket-Accpet-的实现，可以参考之前的分析。握手过程的具体代码如下："><a href="#根据之前的协议分析，我知道握手的过程其实就是检查-HTTP-请求头部字段的过程，值得注意的一点就是需要针对客户端发送的-Sec-WebSocket-Key-生成一个正确的-Sec-WebSocket-Accept-只。关于生成的-Sec-WebSocket-Accpet-的实现，可以参考之前的分析。握手过程的具体代码如下：" class="headerlink" title="根据之前的协议分析，我知道握手的过程其实就是检查 HTTP 请求头部字段的过程，值得注意的一点就是需要针对客户端发送的 Sec-WebSocket-Key 生成一个正确的 Sec-WebSocket-Accept 只。关于生成的 Sec-WebSocket-Accpet 的实现，可以参考之前的分析。握手过程的具体代码如下："></a>根据之前的协议分析，我知道握手的过程其实就是检查 HTTP 请求头部字段的过程，值得注意的一点就是需要针对客户端发送的 <code>Sec-WebSocket-Key</code> 生成一个正确的 <code>Sec-WebSocket-Accept</code> 只。关于生成的 <code>Sec-WebSocket-Accpet</code> 的实现，可以参考之前的分析。握手过程的具体代码如下：</h3><h3 id="upgrade-go"><a href="#upgrade-go" class="headerlink" title="@upgrade.go"></a>@upgrade.go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> websocket</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span>(</span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"net"</span></span><br><span class="line">    <span class="string">"errors"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"bufio"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Upgrade</span><span class="params">(w http.ResponseWriter,r *http.Request)</span><span class="params">(c *Conn,err error)</span></span>&#123;</span><br><span class="line">    <span class="comment">//是否是Get方法</span></span><br><span class="line">    <span class="keyword">if</span> r.Method != <span class="string">"GET"</span> &#123;</span><br><span class="line">        http.Error(w,http.StatusText(http.StatusMethodNotAllowed),http.StatusMethodNotAllowed)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,errors.New(<span class="string">"websocket:method not GET"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//检查 Sec-WebSocket-Version 版本</span></span><br><span class="line">    <span class="keyword">if</span> values := r.Header[<span class="string">"Sec-Websocket-Version"</span>];<span class="built_in">len</span>(values) == <span class="number">0</span> || values[<span class="number">0</span>] != <span class="string">"13"</span> &#123;</span><br><span class="line">        http.Error(w,http.StatusText(http.StatusBadRequest),http.StatusBadRequest)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,errors.New(<span class="string">"websocket:version != 13"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查Connection 和  Upgrade</span></span><br><span class="line">    <span class="keyword">if</span> !tokenListContainsValue(r.Header,<span class="string">"Connection"</span>,<span class="string">"upgrade"</span>) &#123;</span><br><span class="line">        http.Error(w,http.StatusText(http.StatusBadRequest),http.StatusBadRequest)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,errors.New(<span class="string">"websocket:could not find connection header with token 'upgrade'"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> !tokenListContainsValue(r.Header,<span class="string">"Upgrade"</span>,<span class="string">"websocket"</span>) &#123;</span><br><span class="line">        http.Error(w,http.StatusText(http.StatusBadRequest),http.StatusBadRequest)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,errors.New(<span class="string">"websocket:could not find connection header with token 'websocket'"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算Sec-Websocket-Accept的值</span></span><br><span class="line">    challengeKey := r.Header.Get(<span class="string">"Sec-Websocket-Key"</span>)</span><br><span class="line">    <span class="keyword">if</span> challengeKey == <span class="string">""</span> &#123;</span><br><span class="line">        http.Error(w,http.StatusText(http.StatusBadRequest),http.StatusBadRequest)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,errors.New(<span class="string">"websocket:key missing or blank"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        netConn net.Conn</span><br><span class="line">        br *bufio.Reader</span><br><span class="line">    )</span><br><span class="line">    h,ok := w.(http.Hijacker)</span><br><span class="line">    <span class="keyword">if</span>  !ok &#123;</span><br><span class="line">        http.Error(w,http.StatusText(http.StatusInternalServerError),http.StatusInternalServerError)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,errors.New(<span class="string">"websocket:response dose not implement http.Hijacker"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> rw *bufio.ReadWriter</span><br><span class="line">    <span class="comment">//接管当前tcp连接，阻止内置http接管连接</span></span><br><span class="line">    netConn,rw,err = h.Hijack()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        http.Error(w,http.StatusText(http.StatusInternalServerError),http.StatusInternalServerError)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    br = rw.Reader</span><br><span class="line">    <span class="keyword">if</span> br.Buffered() &gt; <span class="number">0</span> &#123;</span><br><span class="line">        netConn.Close()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,errors.New(<span class="string">"websocket:client send data before hanshake is complete"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 构造握手成功后返回的 response</span></span><br><span class="line">    p := []<span class="keyword">byte</span>&#123;&#125;</span><br><span class="line">    p = <span class="built_in">append</span>(p, <span class="string">"HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Accept: "</span>...)</span><br><span class="line">    p = <span class="built_in">append</span>(p, computeAcceptKey(challengeKey)...)</span><br><span class="line">    p = <span class="built_in">append</span>(p, <span class="string">"\r\n\r\n"</span>...)</span><br><span class="line">    <span class="comment">//返回repson 但不关闭连接</span></span><br><span class="line">    <span class="keyword">if</span> _,err = netConn.Write(p);err != <span class="literal">nil</span> &#123;</span><br><span class="line">        netConn.Close()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//升级为websocket</span></span><br><span class="line">    log.Println(<span class="string">"Upgrade http to websocket successfully"</span>)</span><br><span class="line">    conn := newConn(netConn)</span><br><span class="line">    <span class="keyword">return</span> conn,<span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="握手过程的代码比较直观，就不多做解释了。到这里-WebSocket-的实现就基本完成了，可以看到有了之前的各种约定，我们实现-WebSocket-协议也是比较简单的。"><a href="#握手过程的代码比较直观，就不多做解释了。到这里-WebSocket-的实现就基本完成了，可以看到有了之前的各种约定，我们实现-WebSocket-协议也是比较简单的。" class="headerlink" title="握手过程的代码比较直观，就不多做解释了。到这里 WebSocket 的实现就基本完成了，可以看到有了之前的各种约定，我们实现 WebSocket 协议也是比较简单的。"></a>握手过程的代码比较直观，就不多做解释了。到这里 WebSocket 的实现就基本完成了，可以看到有了之前的各种约定，我们实现 WebSocket 协议也是比较简单的。</h3><h2 id="封装的websocket结构体和对应的方法"><a href="#封装的websocket结构体和对应的方法" class="headerlink" title="封装的websocket结构体和对应的方法"></a>封装的websocket结构体和对应的方法</h2><h3 id="conn-go"><a href="#conn-go" class="headerlink" title="@conn.go"></a>@conn.go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> websocket</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"encoding/binary"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"errors"</span></span><br><span class="line">    <span class="string">"net"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 是否是最后一个数据帧</span></span><br><span class="line"><span class="comment">    * Fin Rsv1 Rsv2 Rsv3 Opcode</span></span><br><span class="line"><span class="comment">    *  1  0    0    0    0 0 0 0  =&gt; 128</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    finalBit = <span class="number">1</span> &lt;&lt; <span class="number">7</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 是否需要掩码处理</span></span><br><span class="line"><span class="comment">    *  Mask payload-len 第一位mask表示是否需要进行掩码处理 后面</span></span><br><span class="line"><span class="comment">    *  7位表示数据包长度 1.0-125 表示长度 2.126 后面需要扩展2 字节 16bit</span></span><br><span class="line"><span class="comment">    *  3.127则扩展8bit</span></span><br><span class="line"><span class="comment">    *  1    0 0 0 0 0 0 0  =&gt; 128</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    maskBit = <span class="number">1</span> &lt;&lt; <span class="number">7</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 文本帧类型</span></span><br><span class="line"><span class="comment">    * 0 0 0 0 0 0 0 1</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    TextMessage = <span class="number">1</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 关闭数据帧类型</span></span><br><span class="line"><span class="comment">    * 0 0 0 0 1 0 0 0</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    CloseMessage = <span class="number">8</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//websocket 连接</span></span><br><span class="line"><span class="keyword">type</span> Conn <span class="keyword">struct</span> &#123;</span><br><span class="line">    writeBuf []<span class="keyword">byte</span></span><br><span class="line">    maskKey [<span class="number">4</span>]<span class="keyword">byte</span></span><br><span class="line">    conn net.Conn</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newConn</span><span class="params">(conn net.Conn)</span>*<span class="title">Conn</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;Conn&#123;conn:conn&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Conn)</span><span class="title">Close</span><span class="params">()</span></span>&#123;</span><br><span class="line">    c.conn.Close()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//发送数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Conn)</span><span class="title">SendData</span><span class="params">(data []<span class="keyword">byte</span>)</span></span>&#123;</span><br><span class="line">    length := <span class="built_in">len</span>(data)</span><br><span class="line">    c.writeBuf = <span class="built_in">make</span>([]<span class="keyword">byte</span>,<span class="number">10</span> + length)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据开始和结束位置</span></span><br><span class="line">    payloadStart := <span class="number">2</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    *数据帧的第一个字节，不支持且只能发送文本类型数据</span></span><br><span class="line"><span class="comment">    *finalBit 1 0 0 0 0 0 0 0</span></span><br><span class="line"><span class="comment">    *                |</span></span><br><span class="line"><span class="comment">    *Text     0 0 0 0 0 0 0 1</span></span><br><span class="line"><span class="comment">    * =&gt;      1 0 0 0 0 0 0 1</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    c.writeBuf[<span class="number">0</span>] = <span class="keyword">byte</span>(TextMessage) | finalBit</span><br><span class="line">    fmt.Printf(<span class="string">"1 bit:%b\n"</span>,c.writeBuf[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据帧第二个字节，服务器发送的数据不需要进行掩码处理</span></span><br><span class="line">    <span class="keyword">switch</span>&#123;</span><br><span class="line">    <span class="comment">//大于2字节的长度</span></span><br><span class="line">    <span class="keyword">case</span> length &gt;= <span class="number">1</span> &lt;&lt; <span class="number">16</span> :<span class="comment">//65536</span></span><br><span class="line">        <span class="comment">//c.writeBuf[1] = byte(0x00) | 127 // 127</span></span><br><span class="line">        c.writeBuf[<span class="number">1</span>] = <span class="keyword">byte</span>(<span class="number">127</span>) <span class="comment">// 127</span></span><br><span class="line">        <span class="comment">//大端写入64位</span></span><br><span class="line">        binary.BigEndian.PutUint64(c.writeBuf[payloadStart:],<span class="keyword">uint64</span>(length))</span><br><span class="line">        <span class="comment">//需要8byte来存储数据长度</span></span><br><span class="line">        payloadStart += <span class="number">8</span></span><br><span class="line">    <span class="keyword">case</span> length &gt; <span class="number">125</span>:</span><br><span class="line">        <span class="comment">//c.writeBuf[1] = byte(0x00) | 126</span></span><br><span class="line">        c.writeBuf[<span class="number">1</span>] = <span class="keyword">byte</span>(<span class="number">126</span>)</span><br><span class="line">        binary.BigEndian.PutUint16(c.writeBuf[payloadStart:],<span class="keyword">uint16</span>(length))</span><br><span class="line">        payloadStart += <span class="number">2</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">//c.writeBuf[1] = byte(0x00) | byte(length)</span></span><br><span class="line">        c.writeBuf[<span class="number">1</span>] = <span class="keyword">byte</span>(length)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">"2 bit:%b\n"</span>,c.writeBuf[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="built_in">copy</span>(c.writeBuf[payloadStart:],data[:])</span><br><span class="line">    c.conn.Write(c.writeBuf[:payloadStart+length])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Conn)</span><span class="title">ReadData</span><span class="params">()</span><span class="params">(data []<span class="keyword">byte</span>,err error)</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> b [<span class="number">8</span>]<span class="keyword">byte</span></span><br><span class="line">    <span class="comment">//读取数据帧的前两个字节</span></span><br><span class="line">    <span class="keyword">if</span> _,err := c.conn.Read(b[:<span class="number">2</span>]); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//开始解析第一个字节 是否还有后续数据帧</span></span><br><span class="line">    final := b[<span class="number">0</span>] &amp; finalBit != <span class="number">0</span></span><br><span class="line">    fmt.Printf(<span class="string">"read data 1 bit :%b\n"</span>,b[<span class="number">0</span>])</span><br><span class="line">    <span class="comment">//不支持数据分片</span></span><br><span class="line">    <span class="keyword">if</span> !final &#123;</span><br><span class="line">        log.Println(<span class="string">"Recived fragemented frame,not support"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,errors.New(<span class="string">"not suppeort fragmented message"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据帧类型</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    *1 0 0 0  0 0 0 1</span></span><br><span class="line"><span class="comment">    *        &amp;</span></span><br><span class="line"><span class="comment">    *0 0 0 0  1 1 1 1</span></span><br><span class="line"><span class="comment">    *0 0 0 0  0 0 0 1</span></span><br><span class="line"><span class="comment">    * =&gt; 1 这样就可以直接获取到类型了</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    frameType := <span class="keyword">int</span>(b[<span class="number">0</span>] &amp; <span class="number">0xf</span>)</span><br><span class="line">    <span class="comment">//如果 关闭类型，则关闭连接</span></span><br><span class="line">    <span class="keyword">if</span> frameType == CloseMessage &#123;</span><br><span class="line">        c.conn.Close()</span><br><span class="line">        log.Println(<span class="string">"Recived closed message,connection will be closed"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,errors.New(<span class="string">"recived closed message"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//只实现了文本格式的传输,编码utf-8</span></span><br><span class="line">    <span class="keyword">if</span> frameType != TextMessage &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,errors.New(<span class="string">"only support text message"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//检查数据帧是否被掩码处理</span></span><br><span class="line">    <span class="comment">//maskBit =&gt; 1 0 0 0 0 0 0 0 任何与他 要么为0 要么为 128</span></span><br><span class="line">    mask := b[<span class="number">1</span>] &amp; maskBit != <span class="number">0</span></span><br><span class="line">    <span class="comment">//数据长度</span></span><br><span class="line">    payloadLen := <span class="keyword">int64</span>(b[<span class="number">1</span>] &amp; <span class="number">0x7F</span>)<span class="comment">//0 1 1 1 1 1 1 1 1 127</span></span><br><span class="line">    dataLen := <span class="keyword">int64</span>(payloadLen)</span><br><span class="line">    <span class="comment">//根据payload length 判断数据的真实长度</span></span><br><span class="line">    <span class="keyword">switch</span> payloadLen &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">126</span>:<span class="comment">//扩展2字节</span></span><br><span class="line">        <span class="keyword">if</span> _,err := c.conn.Read(b[:<span class="number">2</span>]);err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>,err</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取扩展二字节的真实数据长度</span></span><br><span class="line">        dataLen = <span class="keyword">int64</span>(binary.BigEndian.Uint16(b[:<span class="number">2</span>]))</span><br><span class="line">    <span class="keyword">case</span> <span class="number">127</span> :</span><br><span class="line">        <span class="keyword">if</span> _,err := c.conn.Read(b[:<span class="number">8</span>]);err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>,err</span><br><span class="line">        &#125;</span><br><span class="line">        dataLen = <span class="keyword">int64</span>(binary.BigEndian.Uint64(b[:<span class="number">8</span>]))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.Printf(<span class="string">"Read data length :%d,payload length %d"</span>,payloadLen,dataLen)</span><br><span class="line">    <span class="comment">//读取mask key</span></span><br><span class="line">    <span class="keyword">if</span> mask &#123;<span class="comment">//如果需要掩码处理的话 需要取出key</span></span><br><span class="line">        <span class="comment">//maskKey 是 4 字节  32位</span></span><br><span class="line">        <span class="keyword">if</span> _,err := c.conn.Read(c.maskKey[:]);err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span> ,err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//读取数据内容</span></span><br><span class="line">    p := <span class="built_in">make</span>([]<span class="keyword">byte</span>,dataLen)</span><br><span class="line">    <span class="keyword">if</span> _,err := c.conn.Read(p);err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> mask &#123;</span><br><span class="line">        maskBytes(c.maskKey,p)<span class="comment">//进行解码</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> p,<span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="http-头部检查"><a href="#http-头部检查" class="headerlink" title="http 头部检查"></a>http 头部检查</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"crypto/sha1"</span></span><br><span class="line">    <span class="string">"encoding/base64"</span></span><br><span class="line">    <span class="string">"strings"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> KeyGUID = []<span class="keyword">byte</span>(<span class="string">"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"</span>)</span><br><span class="line"><span class="comment">//握手阶段使用 加密key返回 进行握手</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">computeAcceptKey</span><span class="params">(challengeKey <span class="keyword">string</span>)</span><span class="title">string</span></span>&#123;</span><br><span class="line">    h := sha1.New()</span><br><span class="line">    h.Write([]<span class="keyword">byte</span>(challengeKey))</span><br><span class="line">    h.Write(KeyGUID)</span><br><span class="line">    <span class="keyword">return</span> base64.StdEncoding.EncodeToString(h.Sum(<span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//解码</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">maskBytes</span><span class="params">(key [4]<span class="keyword">byte</span>,b []<span class="keyword">byte</span>)</span></span>&#123;</span><br><span class="line">    pos := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> b &#123;</span><br><span class="line">        b[i] ^= key[pos &amp; <span class="number">3</span>]</span><br><span class="line">        pos ++</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查http 头部字段中是否包含指定的值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tokenListContainsValue</span><span class="params">(header http.Header, name <span class="keyword">string</span>, value <span class="keyword">string</span>)</span><span class="title">bool</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> _,v := <span class="keyword">range</span> header[name] &#123;</span><br><span class="line">        <span class="keyword">for</span> _, s := <span class="keyword">range</span> strings.Split(v,<span class="string">","</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> strings.EqualFold(value,strings.TrimSpace(s)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><footer class="article-footer"></footer></div></article><nav id="article-nav"> <a href="/wiki/net-protocol/3.传输层/tcp/1.头部/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title"> tcp头部</div></a> <a href="/wiki/net-protocol/2.应用层/websocket/2.websocket算法/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">websocket算法</div></a></nav><script type="text/javascript">!function(){var e=window.location.href,r=document.referrer;if(!/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi.test(e)){var o="//api.share.baidu.com/s.gif";r?(o+="?r="+encodeURIComponent(document.referrer),e&&(o+="&l="+e)):e&&(o+="?l="+e),(new Image).src=o}}(window)</script></section></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner"> brewlin &copy; 2019 <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png"></a><br> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme - <a href="https://github.com/zthxxx/hexo-theme-Wikitten">wikitten</a><br><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span></span> |<span id="busuanzi_container_site_pv"><i class="fa fa-user"><span id="busuanzi_value_site_uv"></span></i></span></div></div></footer><script src="/libs/lightgallery/js/lightgallery.min.js"></script><script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script><script src="/libs/lightgallery/js/lg-pager.min.js"></script><script src="/libs/lightgallery/js/lg-autoplay.min.js"></script><script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script><script src="/libs/lightgallery/js/lg-zoom.min.js"></script><script src="/libs/lightgallery/js/lg-hash.min.js"></script><script src="/libs/lightgallery/js/lg-share.min.js"></script><script src="/libs/lightgallery/js/lg-video.min.js"></script><script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true,
            TeX: {
                equationNumbers: {
                  autoNumber: 'AMS'
                }
            }
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script><script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/main.js"></script></div></body>